# -*- mode: makefile;-*-
#
# Copyright (C) 1999-2012 Apple Inc. All rights reserved.
#
# MakeInc.rule defines the targets and rules for
# leaf directories once MakeInc.dir has recursed
# into them. "do_XXX" may be double-colon rules
# to allow the Makefile in the source directory
# to augment the actions that will be performed.
#

#
# Generic Install rules
#

ifndef INSTALL_KF_MI_LCL_LIST
    INSTALL_KF_MI_LCL_LIST = $(EXPORT_MI_LIST)
endif

ifndef INSTALL_KF_MI_LCL_GEN_LIST
    INSTALL_KF_MI_LCL_GEN_LIST = $(EXPORT_MI_GEN_LIST)
endif

ifndef INSTALL_KF_MD_LCL_LIST
    INSTALL_KF_MD_LCL_LIST = $(EXPORT_MD_LIST)
endif

ifndef INSTALL_KF_MD_LCL_GEN_LIST
    INSTALL_KF_MD_LCL_GEN_LIST = $(EXPORT_MD_GEN_LIST)
endif

ifndef INSTALL_KF_MI_LIST
    INSTALL_KF_MI_LIST = $(EXPORT_MI_LIST)
endif

ifndef INSTALL_KF_MI_GEN_LIST
    INSTALL_KF_MI_GEN_LIST = $(EXPORT_MI_GEN_LIST)
endif

ifndef INSTALL_KF_MD_LIST
    INSTALL_KF_MD_LIST = $(EXPORT_MD_LIST)
endif

ifndef INSTALL_KF_MD_GEN_LIST
    INSTALL_KF_MD_GEN_LIST = $(EXPORT_MD_GEN_LIST)
endif

.PHONY: ALWAYS

<<<<<<< HEAD
ALWAYS:
=======
INSTALL_MI_GEN_FILES = $(addprefix $(DSTROOT)/$(INCDIR)/$(INSTALL_MI_DIR)/, $(INSTALL_MI_GEN_LIST))

$(INSTALL_MI_GEN_FILES): $(DSTROOT)/$(INCDIR)/$(INSTALL_MI_DIR)/% : %
	@true echo Installing $< in $(dir $@)
	$(_v)[ -d $(DSTROOT)/$(INCDIR)/$(INSTALL_MI_DIR) ] ||$(MKDIR) $(DSTROOT)/$(INCDIR)/$(INSTALL_MI_DIR);	\
	filename=`$(BASENAME) $<`;				\
	filename_strip=$(addsuffix .strip,$${filename});	\
	$(RM) $(RMFLAGS) $@;					\
	[ -d ./incmidir ] || $(MKDIR) ./incmidir;			\
	echo garbage > ./incmidir/$${filename_strip};		\
	$(UNIFDEF) $(SINCFRAME_UNIFDEF)				\
		$< > ./incmidir/$${filename} ||			\
		$(DECOMMENT) ./incmidir/$${filename} r >		\
		./incmidir/$${filename_strip};			\
	if [ -s ./incmidir/$${filename_strip} ];			\
	then (							\
		$(INSTALL) $(INSTALL_FLAGS) ./incmidir/$${filename} $(dir $@);\
	);							\
	else							\
		echo Header file $< not exported;		\
	fi;

INSTALL_KF_MI_GEN_FILES = $(addprefix  $(DSTROOT)/$(KINCDIR)/$(EXPORT_MI_DIR)/, $(INSTALL_KF_MI_GEN_LIST))

$(INSTALL_KF_MI_GEN_FILES): $(DSTROOT)/$(KINCDIR)/$(EXPORT_MI_DIR)/% : %
	@true echo Installing $< in $(midir $@)
	$(_v)[ -d $(DSTROOT)/$(KINCDIR)/$(EXPORT_MI_DIR) ] ||$(MKDIR) $(DSTROOT)/$(KINCDIR)/$(EXPORT_MI_DIR);	\
	filename=`$(BASENAME) $<`;				\
	filename_strip=$(addsuffix .strip,$${filename});	\
	$(RM) $(RMFLAGS) $@;					\
	[ -d ./kincmidir ] || $(MKDIR) ./kincmidir;			\
	echo garbage > ./kincmidir/$${filename_strip};		\
	$(UNIFDEF) $(KINCFRAME_UNIFDEF)				\
		$< > ./kincmidir/$${filename} ||			\
		$(DECOMMENT) ./kincmidir/$${filename} r >		\
		./kincmidir/$${filename_strip};			\
	if [ -s ./kincmidir/$${filename_strip} ];			\
	then (							\
		$(INSTALL) $(INSTALL_FLAGS) ./kincmidir/$${filename} $(dir $@);\
	);							\
	else							\
		echo Header file $< not exported;		\
	fi;

INSTALL_MI_GEN_LCL_FILES = $(addprefix $(DSTROOT)/$(LCLDIR)/$(INSTALL_MI_DIR)/, $(INSTALL_MI_LCL_GEN_LIST))

$(INSTALL_MI_GEN_LCL_FILES): $(DSTROOT)/$(LCLDIR)/$(INSTALL_MI_DIR)/% : %
	@true echo Installing $< in $(dir $@)
	$(_v)[ -d $(DSTROOT)/$(LCLDIR)/$(INSTALL_MI_DIR) ] ||$(MKDIR) $(DSTROOT)/$(LCLDIR)/$(INSTALL_MI_DIR);	\
	filename=`$(BASENAME) $<`;				\
	filename_strip=$(addsuffix .strip,$${filename});	\
	$(RM) $(RMFLAGS) $@;					\
	[ -d ./pincmidir ] || $(MKDIR) ./pincmidir;			\
	echo garbage > ./pincmidir/$${filename_strip};		\
	$(UNIFDEF) $(SPINCFRAME_UNIFDEF)			\
		$< > ./pincmidir/$${filename} ||			\
		$(DECOMMENT) ./pincmidir/$${filename} r >		\
		./pincmidir/$${filename_strip};			\
	if [ -s ./pincmidir/$${filename_strip} ];			\
	then (							\
		$(INSTALL) $(INSTALL_FLAGS) ./pincmidir/$${filename} $(dir $@);\
	);							\
	else							\
		echo Header file $< not exported;		\
	fi;

INSTALL_KF_MI_LCL_GEN_FILES = $(addprefix  $(DSTROOT)/$(KPINCDIR)/$(EXPORT_MI_DIR)/, $(INSTALL_KF_MI_LCL_GEN_LIST))

$(INSTALL_KF_MI_LCL_GEN_FILES): $(DSTROOT)/$(KPINCDIR)/$(EXPORT_MI_DIR)/% : %
	@true echo Installing $< in $(dir $@)
	$(_v)[ -d $(DSTROOT)/$(KPINCDIR)/$(EXPORT_MI_DIR) ] ||$(MKDIR) $(DSTROOT)/$(KPINCDIR)/$(EXPORT_MI_DIR);	\
	filename=`$(BASENAME) $<`;				\
	filename_strip=$(addsuffix .strip,$${filename});	\
	$(RM) $(RMFLAGS) $@;					\
	[ -d ./kpincmidir ] || $(MKDIR) ./kpincmidir;			\
	echo garbage > ./kpincmidir/$${filename_strip};		\
	$(UNIFDEF) $(KPINCFRAME_UNIFDEF)			\
		$< > ./kpincmidir/$${filename} ||			\
		$(DECOMMENT) ./kpincmidir/$${filename} r >		\
		./kpincmidir/$${filename_strip};			\
	if [ -s ./kpincmidir/$${filename_strip} ];			\
	then (							\
		$(INSTALL) $(INSTALL_FLAGS) ./kpincmidir/$${filename} $(dir $@);\
	);							\
	else							\
		echo Header file $< not exported;		\
	fi;

INSTALL_MD_GEN_INC_FILES = $(addprefix $(DSTROOT)/$(INCDIR)/$(INSTALL_MD_DIR)/, $(INSTALL_MD_GEN_LIST))

$(INSTALL_MD_GEN_INC_FILES): $(DSTROOT)/$(INCDIR)/$(INSTALL_MD_DIR)/% : %
	@true echo Installing $< in $(dir $@)
	$(_v)[ -d $(DSTROOT)/$(INCDIR)/$(INSTALL_MD_DIR) ] ||$(MKDIR) $(DSTROOT)/$(INCDIR)/$(INSTALL_MD_DIR);	\
	filename=`$(BASENAME) $<`;				\
	filename_strip=$(addsuffix .strip,$${filename});	\
	$(RM) $(RMFLAGS) $@;					\
	[ -d ./incdir ] || $(MKDIR) ./incdir;			\
	echo garbage > ./incdir/$${filename_strip};		\
	$(UNIFDEF) $(SINCFRAME_UNIFDEF)				\
		$< > ./incdir/$${filename} ||		\
		$(DECOMMENT) ./incdir/$${filename} r >		\
		./incdir/$${filename_strip};			\
	if [ -s ./incdir/$${filename_strip} ];			\
	then (							\
		$(INSTALL) $(INSTALL_FLAGS) ./incdir/$${filename} $(dir $@);\
	);							\
	else							\
		echo Header file $< not exported;		\
	fi;
>>>>>>> origin/10.5

# $(1) is the list of install paths
# $(2) is "1" if it's a "GEN"-style rule that looks locally, or else $(SOURCE)
# $(3) is the local temp directory for processing
# $(4) is the unifdef flags
#
# $$$$$$$$ is a double-escaped "$$" to represent the current pid
# of the shell process for creating uniquely named temporary files

<<<<<<< HEAD
define INSTALLHDRS_RULE_template
=======
$(INSTALL_KF_MD_GEN_FILES): $(DSTROOT)/$(KINCDIR)/$(EXPORT_MD_DIR)/% : %
	@true echo Installing $< in $(dir $@)
	$(_v)[ -d $(DSTROOT)/$(KINCDIR)/$(EXPORT_MD_DIR) ] ||$(MKDIR) $(DSTROOT)/$(KINCDIR)/$(EXPORT_MD_DIR);	\
	filename=`$(BASENAME) $<`;				\
	filename_strip=$(addsuffix .strip,$${filename});	\
	$(RM) $(RMFLAGS) $@;					\
	[ -d ./kincdir ] || $(MKDIR) ./kincdir;			\
	echo garbage > ./kincdir/$${filename_strip};		\
	$(UNIFDEF) $(KINCFRAME_UNIFDEF)				\
		$< > ./kincdir/$${filename} ||			\
		$(DECOMMENT) ./kincdir/$${filename} r >		\
		./kincdir/$${filename_strip};			\
	if [ -s ./kincdir/$${filename_strip} ];			\
	then (							\
		$(INSTALL) $(INSTALL_FLAGS) ./kincdir/$${filename} $(dir $@);\
	);							\
	else							\
		echo Header file $< not exported;		\
	fi;

INSTALL_MD_LCL_FILES = $(addprefix $(SOURCE), $(INSTALL_MD_LCL_LIST))
INSTALL_MD_GEN_LCL_FILES = $(addprefix $(DSTROOT)/$(LCLDIR)/$(INSTALL_MD_DIR)/, $(INSTALL_MD_LCL_GEN_LIST))

$(INSTALL_MD_GEN_LCL_FILES): $(DSTROOT)/$(LCLDIR)/$(INSTALL_MD_DIR)/% : %
	@true echo Installing $< in $(dir $@)
	$(_v)[ -d $(DSTROOT)/$(LCLDIR)/$(INSTALL_MD_DIR) ] ||$(MKDIR) $(DSTROOT)/$(LCLDIR)/$(INSTALL_MD_DIR);	\
	filename=`$(BASENAME) $<`;				\
	filename_strip=$(addsuffix .strip,$${filename});	\
	$(RM) $(RMFLAGS) $@;					\
	[ -d ./pincdir ] || $(MKDIR) ./pincdir;			\
	echo garbage > ./pincdir/$${filename_strip};		\
	$(UNIFDEF) $(SPINCFRAME_UNIFDEF)			\
		$< > ./pincdir/$${filename} ||			\
		$(DECOMMENT) ./pincdir/$${filename} r >		\
		./pincdir/$${filename_strip};			\
	if [ -s ./pincdir/$${filename_strip} ];			\
	then (							\
		$(INSTALL) $(INSTALL_FLAGS) ./pincdir/$${filename} $(dir $@);\
	);							\
	else							\
		echo Header file $< not exported;		\
	fi;
>>>>>>> origin/10.5

.PHONY: $(3)_MKDIR

<<<<<<< HEAD
$(3)_MKDIR:
	$$(_v)$$(MKDIR) ./$(3)
	$$(_v)$$(MKDIR) $(dir $(firstword $(1)))

# Rebuild if unifdef flags change
$(1): $(3)/.UNIFDEF_FLAGS
$(3)/.UNIFDEF_FLAGS: ALWAYS | $(3)_MKDIR
	$$(_v)$$(REPLACECONTENTS) $$@ $$(UNIFDEF) $(4)

$(1): $(dir $(firstword $(1)))% : $(if $(2),%,$$(SOURCE)/%) | $(3)_MKDIR
	@echo INSTALLHDR $$*
	$$(_v)$$(UNIFDEF) $(4) $$< > ./$(3)/$$*.unifdef.$$$$$$$$;	\
	if [ $$$$? -eq 2 ]; then						\
		echo Parse failure for $$<;				\
		exit 1;							\
	fi;								\
	$$(DECOMMENT) ./$(3)/$$*.unifdef.$$$$$$$$ r >			\
		./$(3)/$$*.strip.$$$$$$$$ || exit 1;			\
	if [ -s ./$(3)/$$*.strip.$$$$$$$$ ]; then			\
		$$(INSTALL) $$(INSTALL_FLAGS) ./$(3)/$$*.unifdef.$$$$$$$$ $$@ || exit 1;	\
=======
$(INSTALL_KF_MD_LCL_GEN_FILES): $(DSTROOT)/$(KPINCDIR)/$(EXPORT_MD_DIR)/% : %
	@true echo Installing $< in $(dir $@)
	$(_v)[ -d $(DSTROOT)/$(KPINCDIR)/$(EXPORT_MD_DIR) ] ||$(MKDIR) $(DSTROOT)/$(KPINCDIR)/$(EXPORT_MD_DIR);	\
	filename=`$(BASENAME) $<`;				\
	filename_strip=$(addsuffix .strip,$${filename});	\
	$(RM) $(RMFLAGS) $@;					\
	[ -d ./kpincdir ] || $(MKDIR) ./kpincdir;			\
	echo garbage > ./kpincdir/$${filename_strip};		\
	$(UNIFDEF) $(KPINCFRAME_UNIFDEF)			\
		$< > ./kpincdir/$${filename} ||			\
		$(DECOMMENT) ./kpincdir/$${filename} r >		\
		./kpincdir/$${filename_strip};			\
	if [ -s ./kpincdir/$${filename_strip} ];			\
	then (							\
		$(INSTALL) $(INSTALL_FLAGS) ./kpincdir/$${filename} $(dir $@);\
	);							\
	else							\
		echo Header file $< not exported;		\
	fi;

setup_installhdrs_mi: 

do_installhdrs_mi: $(INSTALL_MI_GEN_FILES) $(INSTALL_MI_GEN_LCL_FILES) $(INSTALL_KF_MI_GEN_FILES) $(INSTALL_KF_MI_LCL_GEN_FILES)
	@true echo "[ $(SOURCE) ] make do_installhdrs_mi $(KERNEL_CONFIG) $(ARCH_CONFIG) $(TARGET)"
	$(_v)$(MKDIR) ./incmidir ./pincmidir ./kincmidir ./kpincmidir;				\
	if [ -n "$(strip $(INSTALL_MI_LIST))" ]; then			\
	    if [ -d $(DSTROOT)/$(INCDIR)/$(INSTALL_MI_DIR) ]; then	\
		(cd $(DSTROOT)/$(INCDIR)/$(INSTALL_MI_DIR);$(RM) $(RMFLAGS) $(INSTALL_MI_LIST) );       \
	    else								\
		$(MKDIR) $(DSTROOT)/$(INCDIR)/$(INSTALL_MI_DIR);	\
	    fi;								\
	    for j in $(INSTALL_MI_LIST);				\
	    do								\
		echo garbage > ./incmidir/$$j.strip;			\
		$(UNIFDEF) $(SINCFRAME_UNIFDEF)				\
		    $(SOURCE)/$$j > ./incmidir/$$j ||			\
		    $(DECOMMENT) ./incmidir/$$j r >			\
		    ./incmidir/$$j.strip;				\
		if [ -s ./incmidir/$$j.strip ];				\
		then (							\
		    $(INSTALL) $(INSTALL_FLAGS) ./incmidir/$$j $(DSTROOT)/$(INCDIR)/$(INSTALL_MI_DIR);	\
		);							\
		else							\
		    echo Header file $$j not exported;		\
		fi;							\
	    done;							\
	fi;								\
	if [ -n "$(strip $(INSTALL_MI_LCL_LIST))" ]; then			\
	    if [ -d $(DSTROOT)/$(LCLDIR)/$(INSTALL_MI_DIR) ]; then	\
		(cd $(DSTROOT)/$(LCLDIR)/$(INSTALL_MI_DIR);$(RM) $(RMFLAGS) $(INSTALL_MI_LCL_LIST) );       \
	    else								\
		$(MKDIR) $(DSTROOT)/$(LCLDIR)/$(INSTALL_MI_DIR);	\
	    fi;								\
	    for j in $(INSTALL_MI_LCL_LIST);				\
	    do								\
		echo garbage > ./pincmidir/$$j.strip;			\
		$(UNIFDEF) $(SPINCFRAME_UNIFDEF)				\
		    $(SOURCE)/$$j > ./pincmidir/$$j ||			\
		    $(DECOMMENT) ./pincmidir/$$j r >			\
		    ./pincmidir/$$j.strip;				\
		if [ -s ./pincmidir/$$j.strip ];				\
		then (							\
		    $(INSTALL) $(INSTALL_FLAGS) ./pincmidir/$$j $(DSTROOT)/$(LCLDIR)/$(INSTALL_MI_DIR);	\
		);							\
		else							\
		    echo Header file $$j not exported;		\
		fi;							\
	    done;							\
	fi;								\
	if [ -n "$(strip $(INSTALL_KF_MI_LIST))" ]; then			\
	    if [ -d $(DSTROOT)/$(KINCDIR)/$(EXPORT_MI_DIR) ]; then	\
		(cd $(DSTROOT)/$(KINCDIR)/$(EXPORT_MI_DIR);$(RM) $(RMFLAGS) $(INSTALL_KF_MI_LIST) );       \
	    else								\
		$(MKDIR) $(DSTROOT)/$(KINCDIR)/$(EXPORT_MI_DIR);	\
	    fi;								\
	    for j in $(INSTALL_KF_MI_LIST);				\
	    do								\
		echo garbage > ./kincmidir/$$j.strip;			\
		$(UNIFDEF) $(KINCFRAME_UNIFDEF)				\
		    $(SOURCE)/$$j > ./kincmidir/$$j ||			\
		    $(DECOMMENT) ./kincmidir/$$j r >			\
		    ./kincmidir/$$j.strip;				\
		if [ -s ./kincmidir/$$j.strip ];				\
		then (							\
		    $(INSTALL) $(INSTALL_FLAGS) ./kincmidir/$$j $(DSTROOT)/$(KINCDIR)/$(EXPORT_MI_DIR);	\
		);							\
		else							\
		    echo Header file $$j not exported;		\
		fi;							\
	    done;							\
	fi;								\
	if [ -n "$(strip $(INSTALL_KF_MI_LCL_LIST))" ]; then			\
	    if [ -d $(DSTROOT)/$(KPINCDIR)/$(EXPORT_MI_DIR) ]; then	\
		(cd $(DSTROOT)/$(KPINCDIR)/$(EXPORT_MI_DIR);$(RM) $(RMFLAGS) $(INSTALL_KF_MI_LCL_LIST) );       \
	    else								\
		$(MKDIR) $(DSTROOT)/$(KPINCDIR)/$(EXPORT_MI_DIR);	\
	    fi;								\
	    for j in $(INSTALL_KF_MI_LCL_LIST);				\
	    do								\
		echo garbage > ./kpincmidir/$$j.strip;			\
		$(UNIFDEF) $(KPINCFRAME_UNIFDEF)				\
		    $(SOURCE)/$$j > ./kpincmidir/$$j ||			\
		    $(DECOMMENT) ./kpincmidir/$$j r >			\
		    ./kpincmidir/$$j.strip;				\
		if [ -s ./kpincmidir/$$j.strip ];				\
		then (							\
		    $(INSTALL) $(INSTALL_FLAGS) ./kpincmidir/$$j $(DSTROOT)/$(KPINCDIR)/$(EXPORT_MI_DIR);	\
		);							\
		else							\
		    echo Header file $$j not exported;		\
		fi;							\
	    done;							\
	fi;								\
	$(RM) -rf ./incmidir ./pincmidir ./kincmidir ./kpincmidir;

setup_installhdrs_md:

do_installhdrs_md: $(INSTALL_MD_GEN_INC_FILES) $(INSTALL_MD_GEN_LCL_FILES) $(INSTALL_KF_MD_GEN_FILES) $(INSTALL_KF_MD_LCL_GEN_FILES)
	@true echo "[ $(SOURCE) ] make do_installhdrs_md $(KERNEL_CONFIG) $(ARCH_CONFIG) $(TARGET)"
	$(_v)$(MKDIR) ./incdir ./pincdir ./kincdir ./kpincdir;				\
	if [ -n "$(strip $(INSTALL_MD_LIST))" ]; then			\
	    if [ -d $(DSTROOT)/$(INCDIR)/$(INSTALL_MD_DIR) ]; then	\
		(cd $(DSTROOT)/$(INCDIR)/$(INSTALL_MD_DIR);$(RM) $(RMFLAGS) $(INSTALL_MD_LIST) );       \
	    else							\
		$(MKDIR) $(DSTROOT)/$(INCDIR)/$(INSTALL_MD_DIR);	\
	    fi;								\
	    for j in $(INSTALL_MD_LIST);				\
	    do								\
		echo garbage > ./incdir/$$j.strip;			\
		$(UNIFDEF) $(SINCFRAME_UNIFDEF)				\
		    $(SOURCE)/$$j > ./incdir/$$j ||			\
		    $(DECOMMENT) ./incdir/$$j r >			\
		    ./incdir/$$j.strip;				\
		if [ -s ./incdir/$$j.strip ];				\
		then (							\
		    $(INSTALL) $(INSTALL_FLAGS) ./incdir/$$j $(DSTROOT)/$(INCDIR)/$(INSTALL_MD_DIR);	\
		);							\
		else							\
		    echo Header file $$j not exported;		\
		fi;							\
	    done;							\
	fi;								\
	if [ -n "$(strip $(INSTALL_MD_LCL_LIST))" ]; then			\
	    if [ -d $(DSTROOT)/$(LCLDIR)/$(INSTALL_MD_DIR) ]; then	\
		(cd $(DSTROOT)/$(LCLDIR)/$(INSTALL_MD_DIR);$(RM) $(RMFLAGS) $(INSTALL_MD_LCL_LIST) );       \
	    else							\
		$(MKDIR) $(DSTROOT)/$(LCLDIR)/$(INSTALL_MD_DIR);	\
	    fi;								\
	    for j in $(INSTALL_MD_LCL_LIST);				\
	    do								\
		echo garbage > ./pincdir/$$j.strip;			\
		$(UNIFDEF) $(SPINCFRAME_UNIFDEF)				\
		    $(SOURCE)/$$j > ./pincdir/$$j ||			\
		    $(DECOMMENT) ./pincdir/$$j r >			\
		    ./pincdir/$$j.strip;				\
		if [ -s ./pincdir/$$j.strip ];				\
		then (							\
		    $(INSTALL) $(INSTALL_FLAGS) ./pincdir/$$j $(DSTROOT)/$(LCLDIR)/$(INSTALL_MD_DIR);	\
		);							\
		else							\
		    echo Header file $$j not exported;		\
		fi;							\
	    done;							\
	fi;								\
	if [ -n "$(strip $(INSTALL_KF_MD_LIST))" ]; then			\
	    if [ -d $(DSTROOT)/$(KINCDIR)/$(EXPORT_MD_DIR) ]; then	\
		(cd $(DSTROOT)/$(KINCDIR)/$(EXPORT_MD_DIR);$(RM) $(RMFLAGS) $(INSTALL_KF_MD_LIST) );       \
	    else							\
		$(MKDIR) $(DSTROOT)/$(KINCDIR)/$(EXPORT_MD_DIR);	\
	    fi;								\
	    for j in $(INSTALL_KF_MD_LIST);				\
	    do								\
		echo garbage > ./kincdir/$$j.strip;			\
		$(UNIFDEF) $(KINCFRAME_UNIFDEF)				\
		    $(SOURCE)/$$j > ./kincdir/$$j ||			\
		    $(DECOMMENT) ./kincdir/$$j r >			\
		    ./kincdir/$$j.strip;				\
		if [ -s ./kincdir/$$j.strip ];				\
		then (							\
		    $(INSTALL) $(INSTALL_FLAGS) ./kincdir/$$j $(DSTROOT)/$(KINCDIR)/$(EXPORT_MD_DIR);	\
		);							\
		else							\
		    echo Header file $$j not exported;		\
		fi;							\
	    done;							\
	fi;								\
	if [ -n "$(strip $(INSTALL_KF_MD_LCL_LIST))" ]; then			\
	    if [ -d $(DSTROOT)/$(KPINCDIR)/$(EXPORT_MD_DIR) ]; then	\
		(cd $(DSTROOT)/$(KPINCDIR)/$(EXPORT_MD_DIR);$(RM) $(RMFLAGS) $(INSTALL_KF_MD_LCL_LIST) );       \
	    else							\
		$(MKDIR) $(DSTROOT)/$(KPINCDIR)/$(EXPORT_MD_DIR);	\
	    fi;								\
	    for j in $(INSTALL_KF_MD_LCL_LIST);				\
	    do								\
		echo garbage > ./kpincdir/$$j.strip;			\
		$(UNIFDEF) $(KPINCFRAME_UNIFDEF)				\
		    $(SOURCE)/$$j > ./kpincdir/$$j ||			\
		    $(DECOMMENT) ./kpincdir/$$j r >			\
		    ./kpincdir/$$j.strip;				\
		if [ -s ./kpincdir/$$j.strip ];				\
		then (							\
		    $(INSTALL) $(INSTALL_FLAGS) ./kpincdir/$$j $(DSTROOT)/$(KPINCDIR)/$(EXPORT_MD_DIR);	\
		);							\
		else							\
		    echo Header file $$j not exported;		\
		fi;							\
	    done;							\
>>>>>>> origin/10.5
	fi;								\
	$$(RM) ./$(3)/$$*.unifdef.$$$$$$$$ ./$(3)/$$*.strip.$$$$$$$$
endef

#
# Machine-independent (public) files
#

INSTALL_MI_INC_FILES = $(addprefix $(DSTROOT)/$(INCDIR)/$(INSTALL_MI_DIR)/, $(INSTALL_MI_LIST))
INSTALL_MI_INC_GEN_FILES = $(addprefix $(DSTROOT)/$(INCDIR)/$(INSTALL_MI_DIR)/, $(INSTALL_MI_GEN_LIST))

$(eval $(call INSTALLHDRS_RULE_template,$(INSTALL_MI_INC_FILES),,incmidir,$(SINCFRAME_UNIFDEF)))
$(eval $(call INSTALLHDRS_RULE_template,$(INSTALL_MI_INC_GEN_FILES),1,incmigendir,$(SINCFRAME_UNIFDEF)))

INSTALL_KF_MI_FILES = $(addprefix $(DSTROOT)/$(KINCDIR)/$(EXPORT_MI_DIR)/, $(INSTALL_KF_MI_LIST))
INSTALL_KF_MI_GEN_FILES = $(addprefix $(DSTROOT)/$(KINCDIR)/$(EXPORT_MI_DIR)/, $(INSTALL_KF_MI_GEN_LIST))

$(eval $(call INSTALLHDRS_RULE_template,$(INSTALL_KF_MI_FILES),,kincmidir,$(KINCFRAME_UNIFDEF)))
$(eval $(call INSTALLHDRS_RULE_template,$(INSTALL_KF_MI_GEN_FILES),1,kincmigendir,$(KINCFRAME_UNIFDEF)))

#
# Machine-independent local (private) files
#

INSTALL_MI_LCL_FILES = $(addprefix $(DSTROOT)/$(LCLDIR)/$(INSTALL_MI_DIR)/, $(sort $(INSTALL_MI_LCL_LIST) $(INSTALL_MI_LIST)))
INSTALL_MI_LCL_GEN_FILES = $(addprefix $(DSTROOT)/$(LCLDIR)/$(INSTALL_MI_DIR)/, $(sort $(INSTALL_MI_LCL_GEN_LIST) $(INSTALL_MI_GEN_LIST)))

$(eval $(call INSTALLHDRS_RULE_template,$(INSTALL_MI_LCL_FILES),,pincmidir,$(SPINCFRAME_UNIFDEF)))
$(eval $(call INSTALLHDRS_RULE_template,$(INSTALL_MI_LCL_GEN_FILES),1,pincmigendir,$(SPINCFRAME_UNIFDEF)))

INSTALL_KF_MI_LCL_FILES = $(addprefix $(DSTROOT)/$(KPINCDIR)/$(EXPORT_MI_DIR)/, $(INSTALL_KF_MI_LCL_LIST))
INSTALL_KF_MI_LCL_GEN_FILES = $(addprefix $(DSTROOT)/$(KPINCDIR)/$(EXPORT_MI_DIR)/, $(INSTALL_KF_MI_LCL_GEN_LIST))

$(eval $(call INSTALLHDRS_RULE_template,$(INSTALL_KF_MI_LCL_FILES),,kpincmidir,$(KPINCFRAME_UNIFDEF)))
$(eval $(call INSTALLHDRS_RULE_template,$(INSTALL_KF_MI_LCL_GEN_FILES),1,kpincmigendir,$(KPINCFRAME_UNIFDEF)))

#
# Machine-dependent (public) files
#

INSTALL_MD_INC_FILES = $(addprefix $(DSTROOT)/$(INCDIR)/$(INSTALL_MD_DIR)/, $(INSTALL_MD_LIST))
INSTALL_MD_INC_GEN_FILES = $(addprefix $(DSTROOT)/$(INCDIR)/$(INSTALL_MD_DIR)/, $(INSTALL_MD_GEN_LIST))

$(eval $(call INSTALLHDRS_RULE_template,$(INSTALL_MD_INC_FILES),,incdir,$(SINCFRAME_UNIFDEF)))
$(eval $(call INSTALLHDRS_RULE_template,$(INSTALL_MD_INC_GEN_FILES),1,incgendir,$(SINCFRAME_UNIFDEF)))

INSTALL_KF_MD_FILES = $(addprefix $(DSTROOT)/$(KINCDIR)/$(EXPORT_MD_DIR)/, $(INSTALL_KF_MD_LIST))
INSTALL_KF_MD_GEN_FILES = $(addprefix $(DSTROOT)/$(KINCDIR)/$(EXPORT_MD_DIR)/, $(INSTALL_KF_MD_GEN_LIST))

$(eval $(call INSTALLHDRS_RULE_template,$(INSTALL_KF_MD_FILES),,kincdir,$(KINCFRAME_UNIFDEF)))
$(eval $(call INSTALLHDRS_RULE_template,$(INSTALL_KF_MD_GEN_FILES),1,kincgendir,$(KINCFRAME_UNIFDEF)))

#
# Machine-dependent local (private) files
#

INSTALL_MD_LCL_FILES = $(addprefix $(DSTROOT)/$(LCLDIR)/$(INSTALL_MD_DIR)/, $(sort $(INSTALL_MD_LCL_LIST) $(INSTALL_MD_LIST)))
INSTALL_MD_LCL_GEN_FILES = $(addprefix $(DSTROOT)/$(LCLDIR)/$(INSTALL_MD_DIR)/, $(sort $(INSTALL_MD_LCL_GEN_LIST) $(INSTALL_MD_GEN_LIST)))

$(eval $(call INSTALLHDRS_RULE_template,$(INSTALL_MD_LCL_FILES),,pincdir,$(SPINCFRAME_UNIFDEF)))
$(eval $(call INSTALLHDRS_RULE_template,$(INSTALL_MD_LCL_GEN_FILES),1,pincgendir,$(SPINCFRAME_UNIFDEF)))

INSTALL_KF_MD_LCL_FILES = $(addprefix $(DSTROOT)/$(KPINCDIR)/$(EXPORT_MD_DIR)/, $(INSTALL_KF_MD_LCL_LIST))
INSTALL_KF_MD_LCL_GEN_FILES = $(addprefix $(DSTROOT)/$(KPINCDIR)/$(EXPORT_MD_DIR)/, $(INSTALL_KF_MD_LCL_GEN_LIST))

$(eval $(call INSTALLHDRS_RULE_template,$(INSTALL_KF_MD_LCL_FILES),,kpincdir,$(KPINCFRAME_UNIFDEF)))
$(eval $(call INSTALLHDRS_RULE_template,$(INSTALL_KF_MD_LCL_GEN_FILES),1,kpincgendir,$(KPINCFRAME_UNIFDEF)))

.PHONY: do_installhdrs_mi

# Double-colon rule so that MakeInc.kernel can add custom behaviors
do_installhdrs_mi:: $(INSTALL_MI_INC_FILES) $(INSTALL_MI_INC_GEN_FILES) $(INSTALL_KF_MI_FILES) $(INSTALL_KF_MI_GEN_FILES) \
		    $(INSTALL_MI_LCL_FILES) $(INSTALL_MI_LCL_GEN_FILES) $(INSTALL_KF_MI_LCL_FILES) $(INSTALL_KF_MI_LCL_GEN_FILES)
	@:

.PHONY: do_installhdrs_md

do_installhdrs_md: $(INSTALL_MD_INC_FILES) $(INSTALL_MD_INC_GEN_FILES) $(INSTALL_KF_MD_FILES) $(INSTALL_KF_MD_GEN_FILES) \
		   $(INSTALL_MD_LCL_FILES) $(INSTALL_MD_LCL_GEN_FILES) $(INSTALL_KF_MD_LCL_FILES) $(INSTALL_KF_MD_LCL_GEN_FILES)
	@:

#
# Generic Export rules
#
EXPORT_MI_INC_FILES = $(addprefix $(OBJROOT)/$(EXPDIR)/$(EXPORT_MI_DIR)/, $(EXPORT_MI_LIST))
EXPORT_MI_GEN_INC_FILES = $(addprefix $(OBJROOT)/$(EXPDIR)/$(EXPORT_MI_DIR)/, $(EXPORT_MI_GEN_LIST))

.PHONY: EXP_MI_INC_DIR

EXP_MI_INC_DIR:
	$(_v)$(MKDIR) $(OBJROOT)/$(EXPDIR)/$(EXPORT_MI_DIR)

$(EXPORT_MI_GEN_INC_FILES): $(OBJROOT)/$(EXPDIR)/$(EXPORT_MI_DIR)/% : % | EXP_MI_INC_DIR
	$(_v)$(INSTALL) $(DATA_INSTALL_FLAGS) $< $@

$(EXPORT_MI_INC_FILES): $(OBJROOT)/$(EXPDIR)/$(EXPORT_MI_DIR)/% : $(SOURCE)/% | EXP_MI_INC_DIR
	$(_v)$(INSTALL) $(DATA_INSTALL_FLAGS) $< $@

EXPORT_MD_INC_FILES = $(addprefix $(OBJROOT)/$(EXPDIR)/$(EXPORT_MD_DIR)/, $(EXPORT_MD_LIST))
EXPORT_MD_GEN_INC_FILES = $(addprefix $(OBJROOT)/$(EXPDIR)/$(EXPORT_MD_DIR)/, $(EXPORT_MD_GEN_LIST))

.PHONY: EXP_MD_INC_DIR

EXP_MD_INC_DIR:
	$(_v)$(MKDIR) $(OBJROOT)/$(EXPDIR)/$(EXPORT_MD_DIR)

$(EXPORT_MD_GEN_INC_FILES): $(OBJROOT)/$(EXPDIR)/$(EXPORT_MD_DIR)/% : % | EXP_MD_INC_DIR
	$(_v)$(INSTALL) $(DATA_INSTALL_FLAGS) $< $@

$(EXPORT_MD_INC_FILES): $(OBJROOT)/$(EXPDIR)/$(EXPORT_MD_DIR)/% : $(SOURCE)/% | EXP_MD_INC_DIR
	$(_v)$(INSTALL) $(DATA_INSTALL_FLAGS) $< $@

.PHONY: do_exporthdrs_mi

do_exporthdrs_mi: $(EXPORT_MI_GEN_INC_FILES) $(EXPORT_MI_INC_FILES)
	@:

.PHONY: do_exporthdrs_md

do_exporthdrs_md: $(EXPORT_MD_GEN_INC_FILES)  $(EXPORT_MD_INC_FILES)
	@:

#
# Generic Compilation rules
#

#
# Compilation rules to generate .o from .s
#

S_RULE_0=@echo AS $@
S_RULE_1A=$(_v)${S_KCC} -c ${SFLAGS} -MD -MF $(@:o=d) -MP ${$@_SFLAGS_ADD} ${INCFLAGS} ${$@_INCFLAGS}
S_RULE_1B=$(<F)
S_RULE_2=

#
# Compilation rules to generate .o from .c for normal files
#
C_RULE_0=@echo CC $@
C_RULE_1A=$(_v)${KCC} -c ${filter-out ${$@_CFLAGS_RM}, ${CFLAGS} ${CWARNFLAGS}} -MD -MF $(@:o=d) -MP ${$@_CFLAGS_ADD} ${$@_CWARNFLAGS_ADD} ${INCFLAGS} ${$@_INCFLAGS} 
C_RULE_1B=$(<F)
ifeq ($(BUILD_MACHO_OBJ),0)
C_RULE_2=
else ifeq ($(DO_CTFCONVERT),1)
C_RULE_2=$(_v)if [ -z "${$@_SKIP_CTFCONVERT}" ]; then ${CTFCONVERT} -l xnu -v -o $@.ctf $@ > /dev/null || true; fi
else
C_RULE_2=
endif
ifeq ($(DO_CTFMACHO), 1)
C_CTFRULE_1A=$(_v)${KCC} -o $@.non_lto -c ${filter-out ${$@_CFLAGS_RM}, ${CFLAGS} ${CWARNFLAGS}} ${$@_CFLAGS_ADD} ${$@_CWARNFLAGS_ADD} ${INCFLAGS} ${$@_INCFLAGS} $(CFLAGS_NOLTO_FLAG) 
C_CTFRULE_1B=$(<F)
C_CTFRULE_2=$(_v)if [ -z "${$@_SKIP_CTFCONVERT}" ]; then ${CTFCONVERT} -l xnu -v -o $@.non_lto.ctf $@.non_lto > /dev/null || true; fi
else
C_CTFRULE_1A=@true 
C_CTFRULE_1B=
C_CTFRULE_2=@true 
endif

#
# Compilation rules to generate .o from .c for driver files
#
C_RULE_0_D=${C_RULE_0}
C_RULE_1A_D=${C_RULE_1A}
C_RULE_1B_D=${C_RULE_1B}
C_RULE_2_D=${C_RULE_2}
C_CTFRULE_1A_D=${C_CTFRULE_1A}
C_CTFRULE_1B_D=${C_CTFRULE_1B}
C_CTFRULE_2_D=${C_CTFRULE_2}

#
# Compilation rules to generate .co from .cp or .cpo from .cpp
#   The config tool slickly changes the last source filename char to 'o'
#   for the object filename.
P_RULE_0=@echo C++ $@
P_RULE_1A=$(_v)${KC++} -o $@ -c ${CXXFLAGS} ${filter-out ${$@_CFLAGS_RM}, ${CFLAGS} ${CXXWARNFLAGS}} -MD -MF $(@:o=d) -MP ${$@_CFLAGS_ADD} ${$@_CXXWARNFLAGS_ADD} ${INCFLAGS} ${$@_INCFLAGS} 
P_RULE_1B=$(<F)
P_RULE_2=
P_CTFRULE_1A=@true 
P_CTFRULE_1B=
P_CTFRULE_2=@true 


#
# This isn't the right place to put this, but we need to := override some settings
# in Makefiles that include the generic helper fragments (like this file)
#
ifeq ($(BUILD_JSON_COMPILATION_DATABASE),1)
HIB_FILES :=
LAST_FILES :=
KLD_FILES :=
endif

.PHONY: do_build_all

# Do-nothing rule, since not all levels of the recursive hierarchy might implement this
# in their local Makefiles. Those that do will use a "::" rule to augment this.
do_build_all::
	@:

.PHONY: do_build_install_primary

# Do-nothing rule, since not all levels of the recursive hierarchy might implement this
# in their local Makefiles. Those that do will use a "::" rule to augment this.
do_build_install_primary::
	@:

.PHONY: do_build_install_non_primary

<<<<<<< HEAD
# Do-nothing rule, since not all levels of the recursive hierarchy might implement this
# in their local Makefiles. Those that do will use a "::" rule to augment this.
do_build_install_non_primary::
	@:
=======
#
# mach_kernel building rules
#
<<<<<<< HEAD
<<<<<<< HEAD
do_build_mach_kernel:
	@echo "[ building mach_kernel ]";
	$(OBJROOT)/$(KERNEL_CONFIG)_$(ARCH_CONFIG)/kernel_newvers	\
	    "`${CAT} $(SRCROOT)/osfmk/conf/kernelversion.major`"	\
	    "`${CAT} $(SRCROOT)/osfmk/conf/kernelversion.minor`"	\
	    "`${CAT} $(SRCROOT)/osfmk/conf/kernelversion.variant`";				\
	${KCC} $(CFLAGS) $(INCLUDES) -c kernel_vers.c;						\
	$(LD) $(LDFLAGS_KERNEL) $(addprefix $(TARGET)/,$(foreach component,$(COMPONENT_LIST), $(addprefix $(component)/$(firstword $($(addsuffix _KERNEL_CONFIG, $(component))) $(KERNEL_CONFIG))/, $(addsuffix .o, $(component))))) kernel_vers.o -o $(TARGET)/mach_kernel.sys $(LD_KERNEL_LIBS);	\
	$(STRIP) $(STRIP_FLAGS) $(TARGET)/mach_kernel.sys -o $(TARGET)/mach_kernel;
=======
do_build_mach_kernel: $(OBJPATH)/kgmacros
	$(_v)$(INSTALL) $(DATA_INSTALL_FLAGS) $(SRCROOT)/config/version.c $(OBJPATH)/version.c;
	$(_v)$(SRCROOT)/config/newvers.pl $(OBJPATH)/version.c > /dev/null;
	@echo CC version.o
	$(_v)${KCC} -c ${filter-out ${${join $@,_CFLAGS_RM}}, ${CFLAGS}} ${${join $@,_CFLAGS_ADD}} ${INCFLAGS} ${${join $@,_INCFLAGS}} $(OBJPATH)/version.c -o $(OBJPATH)/version.o
=======
ifeq ($(COMPONENT), .)
do_build_all: do_build_mach_kernel

STATIC_KMODS =  $(SRCROOT)/kmods.a

do_build_mach_kernel: $(TARGET)/kgmacros $(TARGET)/mach_kernel

$(TARGET)/mach_kernel: $(addprefix $(TARGET)/,$(foreach component,$(COMPONENT_LIST), $(addprefix $(component)/$(firstword $($(addsuffix _KERNEL_CONFIG, $(shell printf $(component) | tr a-z A-Z))) $(KERNEL_CONFIG))/, $(addsuffix .o, $(component))))) lastkernelconstructor.o
	$(_v)${MAKE} version.o
	$(_v)${MAKE} build_mach_kernel_exports
>>>>>>> origin/10.6
	@echo LD mach_kernel.sys
	$(_v)$(LD) $(LDFLAGS_KERNEL) $(addprefix $(TARGET)/,$(foreach component,$(COMPONENT_LIST), $(addprefix $(component)/$(firstword $($(addsuffix _KERNEL_CONFIG, $(shell printf $(component) | tr a-z A-Z))) $(KERNEL_CONFIG))/, $(addsuffix .o, $(component))))) $(OBJPATH)/version.o -o $(TARGET)/mach_kernel.sys $(LD_KERNEL_LIBS)
	@echo DSYMUTIL mach_kernel.sys
	$(_v)if [ $(BUILD_DWARF)  -eq  1 ]; then \
		$(DSYMUTIL) $(DSYMUTIL_FLAGS) $(TARGET)/mach_kernel.sys -o $(TARGET)/mach_kernel.sys.dSYM > /dev/null; \
	fi;
	@echo STRIP mach_kernel
	$(_v)$(STRIP) $(STRIP_FLAGS) $(TARGET)/mach_kernel.sys -o $(TARGET)/mach_kernel

$(OBJPATH)/kgmacros: $(SRCROOT)/kgmacros
	$(_v)$(INSTALL) $(INSTALL_FLAGS) $? $@

.PHONY: build_mach_kernel_exports
build_mach_kernel_exports:
	$(_v)${MAKE}					\
		MAKEFILES=${SOURCE}/config/Makefile	\
		SOURCE=${SOURCE}/config			\
		TARGET=$${TARGET}			\
	build_mach_kernel_exports;

# Special rules to install machine configuration variants

$(DSTROOT)$(INSTALL_FILE_DIR)mach.$(KERNEL_CONFIG_LC).$(MACHINE_CONFIG_LC): $(TARGET)/mach_kernel force_file_install
	@echo Installing $< in $@;
	$(_v)if [ ! -e $(DSTROOT)$(INSTALL_FILE_DIR) ]; then	\
		$(MKDIR) $(DSTROOT)$(INSTALL_FILE_DIR);		\
	fi;							\
	if [ "`echo $(INSTALL_ARCHS_LC) | wc -w`" -eq 1 ]; then	\
		$(RM) $(RMFLAGS) $@;				\
		$(INSTALL) $(FILE_INSTALL_FLAGS) $< $@;		\
	else							\
		if [ ! -e $@ ]; then				\
			echo >empty_file_$(notdir $@);			\
			lipo_arg="$(subst _empty_file, empty_file_$(notdir $@),$(foreach lipo_arch,$(INSTALL_ARCHS_LC), $(addprefix -arch , $(addsuffix _empty_file, $(lipo_arch)))))"; \
			$(LIPO) $${lipo_arg} -create -output $@;	\
			$(RM) $(RMFLAGS) empty_file_$(notdir $@);	\
		fi;							\
		$(LIPO) $@ -replace $(ARCH_CONFIG_LC)  $< -o $@;	\
	fi;								\
	if [ $(BUILD_DWARF) -eq 1 ]; then				\
		if [ "`echo $(INSTALL_ARCHS_LC) | wc -w`" -eq 1 ]; then	\
			$(CP) -f $< $<.ctfsys;				\
			$(FIND) $(OBJPATH)/ -name \*.ctf -size 0	\
				-exec $(RM) -rf {} \;	;		\
			$(CTFMERGE) -l xnu -o $<.ctfsys 		\
				$(OBJPATH)/*/$(KERNEL_CONFIG)/*.*o.ctf || true;	\
			$(INSTALL) $(FILE_INSTALL_FLAGS) $<.ctfsys $@.ctfsys; \
		else							\
			if [ ! -e $@.ctfsys ]; then			\
				echo >empty_file_$(notdir $@);		\
				lipo_arg="$(subst _empty_file, empty_file_$(notdir $@),$(foreach lipo_arch,$(INSTALL_ARCHS_LC), $(addprefix -arch , $(addsuffix _empty_file, $(lipo_arch)))))"; \
				$(LIPO) $${lipo_arg} -create -output $@.ctfsys;\
				$(RM) $(RMFLAGS) empty_file_$(notdir $@);\
			fi;						\
			$(FIND) $(OBJPATH)/ -name \*.ctf -size 0	\
				-exec $(RM) -rf {} \;	;		\
			$(CP) -f $< $<.ctfsys;				\
			$(CTFMERGE) -l xnu -o $<.ctfsys			\
				$(OBJPATH)/*/$(KERNEL_CONFIG)/*.*o.ctf || true;	\
			$(LIPO) $@.ctfsys -replace $(ARCH_CONFIG_LC)	\
				$<.ctfsys -o $@.ctfsys;			\
		fi;							\
	fi

$(SYMROOT)$(INSTALL_FILE_DIR)mach.$(KERNEL_CONFIG_LC).$(MACHINE_CONFIG_LC): $(TARGET)/mach_kernel.sys force_file_install
	@echo Installing $< in $@;
	$(_v)if [ ! -e $(SYMROOT)$(INSTALL_FILE_DIR) ]; then	\
		$(MKDIR) $(SYMROOT)$(INSTALL_FILE_DIR);		\
	fi;							\
	if [ "`echo $(INSTALL_ARCHS_LC) | wc -w`" -eq 1 ]; then	\
		$(RM) $(RMFLAGS) $@;				\
		$(INSTALL) $(FILE_INSTALL_FLAGS) $< $@;		\
		if [ $(BUILD_DWARF) -eq 1 ]; then			\
			$(RM) -rf $@.dSYM;				\
			$(MKDIR) -p -m 0755 $@.dSYM/$(DSYMBUILDDIR);	\
			$(INSTALL) $(INSTALL_FLAGS)			\
				$<.dSYM/$(DSYMBUILDDIR)/$(notdir $<)	\
				$@.dSYM/$(DSYMBUILDDIR)/$(notdir $@);	\
		fi;							\
	else							\
		if [ ! -e $@ ]; then				\
			echo >empty_file_$(notdir $@);			\
			lipo_arg="$(subst _empty_file, empty_file_$(notdir $@),$(foreach lipo_arch,$(INSTALL_ARCHS_LC), $(addprefix -arch , $(addsuffix _empty_file, $(lipo_arch)))))"; \
			$(LIPO) $${lipo_arg} -create -output $@;	\
			$(RM) $(RMFLAGS) empty_file_$(notdir $@);		\
		fi;							\
		$(LIPO) $@ -replace $(ARCH_CONFIG_LC)  $< -o $@;	\
	fi


>>>>>>> origin/10.5
#
# Generic Install rules
#
INSTALL_FILE_FILES = $(addprefix $(DSTROOT)$(INSTALL_FILE_DIR), $(INSTALL_FILE_LIST))

force_file_install:

$(INSTALL_FILE_FILES): $(DSTROOT)$(INSTALL_FILE_DIR)% : $(TARGET)/% force_file_install
	@echo Installing $< in $@;
<<<<<<< HEAD
	@$(MKDIR) $(DSTROOT)$(INSTALL_FILE_DIR);			\
	if [ "`echo $(INSTALL_ARCHS_LC) | wc -w`" -eq 1 ]; then	\
		$(RM) $(RMFLAGS) $@;				\
		install $(FILE_INSTALL_FLAGS) $< $(dir $@);		\
	else							\
		if [ ! -e $@ ]; then				\
			echo >empty_file;			\
			lipo_arg="$(subst _empty_file, empty_file,$(foreach lipo_arch,$(INSTALL_ARCHS_LC), $(addprefix -arch , $(addsuffix _empty_file, $(lipo_arch)))))"; \
=======
	$(_v)if [ ! -e $(DSTROOT)$(INSTALL_FILE_DIR) ]; then		\
		$(MKDIR) $(DSTROOT)$(INSTALL_FILE_DIR);			\
	fi;								\
	if [ "`echo $(INSTALL_ARCHS_LC) | wc -w`" -eq 1 ]; then		\
		$(RM) $(RMFLAGS) $@;					\
		if [ $(MACHINE_CONFIG) = DEFAULT ]; then		\
			$(INSTALL) $(FILE_INSTALL_FLAGS) $< $@;		\
		fi;							\
	else								\
		if [ ! -e $@ ]; then					\
			echo >empty_file_$(notdir $@);			\
			lipo_arg="$(subst _empty_file, empty_file_$(notdir $@),$(foreach lipo_arch,$(INSTALL_ARCHS_LC), $(addprefix -arch , $(addsuffix _empty_file, $(lipo_arch)))))"; \
>>>>>>> origin/10.5
			$(LIPO) $${lipo_arg} -create -output $@;	\
			$(RM) $(RMFLAGS) empty_file;			\
		fi;										\
		$(LIPO) $@ -replace $(ARCH_CONFIG_LC)  $< -o $@;	\
<<<<<<< HEAD
=======
	fi;								\
	if [ $(BUILD_DWARF) -eq 1 ]; then				\
		if [ "`echo $(INSTALL_ARCHS_LC) | wc -w`" -eq 1 ]; then	\
			$(CP) -f $< $<.ctfsys;				\
			$(FIND) $(OBJPATH)/ -name \*.ctf -size 0	\
				-exec $(RM) -rf {} \;	;		\
			$(CTFMERGE) -l xnu -o $<.ctfsys 		\
				$(OBJPATH)/*/$(KERNEL_CONFIG)/*.*o.ctf || true;	\
			if [ $(MACHINE_CONFIG) = DEFAULT ]; then	\
				$(INSTALL) $(FILE_INSTALL_FLAGS) $<.ctfsys $(dir $@); \
			fi;						\
		else							\
			if [ ! -e $@.ctfsys ]; then			\
				echo >empty_file_$(notdir $@);		\
				lipo_arg="$(subst _empty_file, empty_file_$(notdir $@),$(foreach lipo_arch,$(INSTALL_ARCHS_LC), $(addprefix -arch , $(addsuffix _empty_file, $(lipo_arch)))))"; \
				$(LIPO) $${lipo_arg} -create -output $@.ctfsys;\
				$(RM) $(RMFLAGS) empty_file_$(notdir $@);\
			fi;						\
			$(FIND) $(OBJPATH)/ -name \*.ctf -size 0	\
				-exec $(RM) -rf {} \;	;		\
			$(CP) -f $< $<.ctfsys;				\
			$(CTFMERGE) -l xnu -o $<.ctfsys			\
				$(OBJPATH)/*/$(KERNEL_CONFIG)/*.*o.ctf || true;	\
			$(LIPO) $@.ctfsys -replace $(ARCH_CONFIG_LC)	\
				$<.ctfsys -o $@.ctfsys;			\
		fi;							\
>>>>>>> origin/10.5
	fi

INSTALL_FILESYS_FILES = $(addprefix $(SYMROOT)$(INSTALL_FILE_DIR), $(INSTALL_FILE_LIST))

force_filesys_install:

$(INSTALL_FILESYS_FILES): $(SYMROOT)$(INSTALL_FILE_DIR)% : $(TARGET)/%.sys force_filesys_install
	@echo Installing $< in $@;
	@$(MKDIR) $(SYMROOT)$(INSTALL_FILE_DIR);			\
	if [ "`echo $(INSTALL_ARCHS_LC) | wc -w`" -eq 1 ]; then	\
		$(RM) $(RMFLAGS) $@;				\
<<<<<<< HEAD
		install $(INSTALL_FLAGS) $< $(dir $@);		\
=======
		$(INSTALL) $(INSTALL_FLAGS) $< $@;			\
		if [ $(BUILD_DWARF) -eq 1 ]; then			\
			$(DSYMUTIL) $(DSYMUTIL_FLAGS)			\
				$(TARGET)/mach_kernel.sys		\
				-o $(TARGET)/mach_kernel.sys.dSYM;	\
			$(RM) -rf $@.dSYM;				\
			$(MKDIR) -p -m 0755 $@.dSYM/$(DSYMBUILDDIR);	\
			$(INSTALL) $(INSTALL_FLAGS)			\
				$<.dSYM/$(DSYMBUILDDIR)/$(notdir $<)	\
				$@.dSYM/$(DSYMBUILDDIR)/$(notdir $@);	\
		fi;							\
>>>>>>> origin/10.5
	else							\
		if [ ! -e $@ ]; then				\
			echo >empty_file;			\
			lipo_arg="$(subst _empty_file, empty_file,$(foreach lipo_arch,$(INSTALL_ARCHS_LC), $(addprefix -arch , $(addsuffix _empty_file, $(lipo_arch)))))"; \
			$(LIPO) $${lipo_arg} -create -output $@;	\
			$(RM) $(RMFLAGS) empty_file;			\
		fi;										\
		$(LIPO) $@ -replace $(ARCH_CONFIG_LC)  $< -o $@;	\
	fi
<<<<<<< HEAD
=======
	$(INSTALL) $(INSTALL_FLAGS) $(SOURCE)kgmacros $(SYMROOT)$(INSTALL_FILE_DIR)
>>>>>>> origin/10.5

INSTALL_DATA_FILES = $(addprefix $(DSTROOT)$(INSTALL_DATA_DIR), $(INSTALL_DATA_LIST))

$(INSTALL_DATA_FILES): $(DSTROOT)$(INSTALL_DATA_DIR)% : $(SOURCE)/%
	@echo Installing $< in $@;
	@$(MKDIR) $(dir $@);		\
	$(RM) $(RMFLAGS) $@;		\
	$(INSTALL) $(DATA_INSTALL_FLAGS) $< $(dir $@);

setup_build_install:
	@echo "[ $(SOURCE) ] make setup_build_install $(KERNEL_CONFIG) $(ARCH_CONFIG) $(TARGET)"

do_build_install: $(INSTALL_FILESYS_FILES) $(INSTALL_FILE_FILES) $(INSTALL_DATA_FILES)
	@echo "[ $(SOURCE) ] make do_build_install $(KERNEL_CONFIG) $(ARCH_CONFIG) $(TARGET)"
>>>>>>> origin/10.2

INSTALL_MAN_FILES = $(addprefix $(DSTROOT)/$(MANDIR)/$(INSTALL_MAN_DIR)/, $(INSTALL_MAN_LIST))

<<<<<<< HEAD
.PHONY: INSTALL_MAN_DIR

INSTALL_MAN_DIR:
	$(_v)$(MKDIR) $(DSTROOT)/$(MANDIR)/$(INSTALL_MAN_DIR)
=======
do_installman: $(INSTALL_MAN_FILES)
	@echo "[ $(SOURCE) ] make do_installman"
	$(_v)if [ -n "$(strip $(INSTALL_MAN_LIST))" ]; then \
		man_dir=$(DSTROOT)/$(MANDIR)/$(INSTALL_MAN_DIR); \
		if [ -d $$man_dir ]; then       \
			( cd $$man_dir;   \
			$(RM) $(RMFLAGS) $(INSTALL_MAN_LIST) $(INSTALL_MAN_LINKS)); \
		else                    \
			$(MKDIR) $$man_dir;     \
		fi;                             \
		echo Installing $(INSTALL_MAN_LIST) in $$man_dir;	\
		$(INSTALL) $(INSTALL_FLAGS) $(INSTALL_MAN_LIST) $$man_dir;	\
		if [ -n "$(strip $(INSTALL_MAN_LINKS))" ]; then \
			set `echo ${INSTALL_MAN_LINKS}`; \
			while : ; do \
				case $$# in \
					0) break;; \
					1) echo "warn: empty INSTALL_MAN_LINKS: $$1"; break;; \
				esac; \
				link_src=$$1; shift; link_dst=$$1; shift; \
				echo "hard linking $${link_src} to $${link_dst}"; \
				ln -f $${man_dir}/$${link_src} $${man_dir}/$${link_dst} ; \
			done; \
		fi; \
	fi

$(INSTALL_MAN_FILES): $(DSTROOT)/$(MANDIR)/$(INSTALL_MAN_DIR)/% : %
	@true echo Installing $< in $(dir $@)
	$(_v)$(MKDIR) $(DSTROOT)/$(MANDIR)/$(INSTALL_MAN_DIR);       \
	$(RM) $(RMFLAGS) $@;                                    \
	$(INSTALL) $(INSTALL_FLAGS) $< $(dir $@);
>>>>>>> origin/10.5

$(INSTALL_MAN_FILES): $(DSTROOT)/$(MANDIR)/$(INSTALL_MAN_DIR)/% : % | INSTALL_MAN_DIR
	@echo MAN $*
	$(_v)$(INSTALL) $(INSTALL_FLAGS) $< $@

define MAN_LINKS_RULE_template
$$(DSTROOT)/$$(MANDIR)/$$(INSTALL_MAN_DIR)/$(2): $$(DSTROOT)/$$(MANDIR)/$$(INSTALL_MAN_DIR)/$(1)
	@echo MANLINK $(2)
	$(_v)ln -f $$< $$@
endef

function_generate_man_links_rules = $(if $(word 1,$(1)),$(eval $(call MAN_LINKS_RULE_template,$(word 1,$(1)),$(word 2,$(1)))) $(DSTROOT)/$(MANDIR)/$(INSTALL_MAN_DIR)/$(word 2,$(1)) $(call function_generate_man_links_rules,$(wordlist 3,$(words $(1)),$(1))))

INSTALL_MAN_FILES_LINKS = $(call function_generate_man_links_rules,$(INSTALL_MAN_LINKS))

.PHONY: do_installman

do_installman: $(INSTALL_MAN_FILES) $(INSTALL_MAN_FILES_LINKS)
	@:

.PHONY: do_textfiles_install

# Do-nothing rule, since not all levels of the recursive hierarchy might implement this
# in their local Makefiles. Those that do will use a "::" rule to augment this.
do_textfiles_install:: do_installman
	@:

.PHONY: do_build_setup

# Do-nothing rule, since not all levels of the recursive hierarchy might implement this
# in their local Makefiles. Those that do will use a "::" rule to augment this.
do_build_setup::
	@:

.PHONY: do_config_all

# Do-nothing rule, since not all levels of the recursive hierarchy might implement this
# in their local Makefiles. Those that do will use a "::" rule to augment this.
do_config_all::
	@:

.PHONY: do_config_install

# Do-nothing rule, since not all levels of the recursive hierarchy might implement this
# in their local Makefiles. Those that do will use a "::" rule to augment this.
do_config_install::
	@:

# vim: set ft=make:
