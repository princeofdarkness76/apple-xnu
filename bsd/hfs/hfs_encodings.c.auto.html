<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>hfs_encodings.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">hfs_encodings.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2000-2013 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/types.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/errno.h&gt;</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">HFS</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/param.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/systm.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/kernel.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/malloc.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/queue.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/utfconv.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/host.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/host_priv.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/OSKextLib.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/OSKextLibPrivate.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;hfs.h&quot;</span>


lck_grp_t * encodinglst_lck_grp;
lck_grp_attr_t * encodinglst_lck_grp_attr;
lck_attr_t * encodinglst_lck_attr;


<span class="enscript-comment">/* hfs encoding converter list */</span>
<span class="enscript-function-name">SLIST_HEAD</span>(encodinglst, hfs_encoding) hfs_encoding_list = {0};

lck_mtx_t  encodinglst_mutex;

<span class="enscript-comment">/* hfs encoding converter entry */</span>
<span class="enscript-type">struct</span>	hfs_encoding {
	SLIST_ENTRY(hfs_encoding)  link;
	<span class="enscript-type">int</span>			refcount;
	<span class="enscript-type">int</span>			kmod_id;
	u_int32_t	encoding;
	hfs_to_unicode_func_t	get_unicode_func;
	unicode_to_hfs_func_t	get_hfsname_func;
};

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MAX_HFS_UNICODE_CHARS</span>	(15*5)

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_HFS_STD</span>
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">unicode_to_mac_roman</span>(UniChar *uni_str, u_int32_t unicodeChars, Str31 hfs_str);
#<span class="enscript-reference">endif</span>

<span class="enscript-type">void</span>
<span class="enscript-function-name">hfs_converterinit</span>(<span class="enscript-type">void</span>)
{
	SLIST_INIT(&amp;hfs_encoding_list);

	encodinglst_lck_grp_attr= lck_grp_attr_alloc_init();
	encodinglst_lck_grp  = lck_grp_alloc_init(<span class="enscript-string">&quot;cnode_hash&quot;</span>, encodinglst_lck_grp_attr);
	encodinglst_lck_attr = lck_attr_alloc_init();

	lck_mtx_init(&amp;encodinglst_mutex, encodinglst_lck_grp, encodinglst_lck_attr);

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_HFS_STD</span>
	<span class="enscript-comment">/*
	 * add resident MacRoman converter and take a reference
	 * since its always &quot;loaded&quot;. MacRoman is the default converter
	 * for HFS standard volumes.
	 *
	 * Only do this if we are actually supporting HFS standard 
	 * volumes. The converter is not used on configurations 
	 * that do not support HFS standard. 
	 */</span>
	hfs_addconverter(0, kTextEncodingMacRoman, mac_roman_to_unicode, unicode_to_mac_roman);
	SLIST_FIRST(&amp;hfs_encoding_list)-&gt;refcount++;
#<span class="enscript-reference">endif</span>

}

#<span class="enscript-reference">if</span> !<span class="enscript-variable-name">CONFIG_HFS_STD</span>

<span class="enscript-comment">/* 
 * Function stubs are needed for KPI export.  
 * It is a little swizzly to have two separate copies of the stub functions in this file
 * but the prototypes of these functions are different if we're using the real headers
 * vs. the dummy prototypes at the end of the file.  (hfs_to_unicode_func_t vs. void*) 
 * 
 * As a result, we need our own copies in the no-HFS-Standard configuration
 */</span>
<span class="enscript-type">int</span> <span class="enscript-function-name">hfs_addconverter</span>( __unused <span class="enscript-type">int</span> id, 
					  __unused u_int32_t encoding, 
					  __unused hfs_to_unicode_func_t get_unicode, 
					  __unused unicode_to_hfs_func_t get_hfsname )
{
	<span class="enscript-keyword">return</span>(0);
}

<span class="enscript-type">int</span> <span class="enscript-function-name">hfs_getconverter</span>(	__unused u_int32_t encoding, 
						__unused hfs_to_unicode_func_t *get_unicode, 
						__unused unicode_to_hfs_func_t *get_hfsname)
{
	<span class="enscript-keyword">return</span>(EINVAL);
}

<span class="enscript-type">int</span> <span class="enscript-function-name">hfs_relconverter</span>(__unused u_int32_t encoding)
{
	<span class="enscript-keyword">return</span>(EINVAL);
}

<span class="enscript-type">int</span> <span class="enscript-function-name">hfs_remconverter</span>(__unused <span class="enscript-type">int</span> id, __unused u_int32_t encoding)
{
	<span class="enscript-keyword">return</span>(0);
}

#<span class="enscript-reference">else</span> 

<span class="enscript-comment">/* 
 * For configurations that do support HFS standard, we need all of these..
 */</span>

<span class="enscript-comment">/*
 * hfs_addconverter - add an HFS encoding converter
 *
 * This is called exclusivly by kernel loadable modules
 * (like HFS_Japanese.kmod) to register hfs encoding
 * conversion routines.
 *
 */</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">hfs_addconverter</span>(<span class="enscript-type">int</span> id, u_int32_t encoding, hfs_to_unicode_func_t get_unicode, unicode_to_hfs_func_t get_hfsname)
{
	<span class="enscript-type">struct</span> hfs_encoding *encp;
	
	MALLOC(encp, <span class="enscript-type">struct</span> hfs_encoding *, <span class="enscript-keyword">sizeof</span>(<span class="enscript-type">struct</span> hfs_encoding), M_TEMP, M_WAITOK);

	lck_mtx_lock(&amp;encodinglst_mutex);

	encp-&gt;link.sle_next = NULL;
	encp-&gt;refcount = 0;
	encp-&gt;encoding = encoding;
	encp-&gt;get_unicode_func = get_unicode;
	encp-&gt;get_hfsname_func = get_hfsname;
	encp-&gt;kmod_id = id;
	SLIST_INSERT_HEAD(&amp;hfs_encoding_list, encp, link);

	lck_mtx_unlock(&amp;encodinglst_mutex);
	<span class="enscript-keyword">return</span> (0);
}


<span class="enscript-comment">/*
 * hfs_remconverter - remove an HFS encoding converter
 *
 * Can be called by a kernel loadable module's finalize
 * routine to remove an encoding converter so that the
 * module (i.e. the code) can be unloaded.
 *
 * However, in the normal case, the removing and unloading
 * of these converters is done in hfs_relconverter.
 * The call is initiated from within the kernel during the unmounting of an hfs voulume.
 */</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">hfs_remconverter</span>(<span class="enscript-type">int</span> id, u_int32_t encoding)
{
	<span class="enscript-type">struct</span> hfs_encoding *encp;

	lck_mtx_lock(&amp;encodinglst_mutex);
	SLIST_FOREACH(encp, &amp;hfs_encoding_list, link) {
		<span class="enscript-keyword">if</span> (encp-&gt;encoding == encoding &amp;&amp; encp-&gt;kmod_id == id) {
			encp-&gt;refcount--;
			
			<span class="enscript-comment">/* if converter is no longer in use, release it */</span>
			<span class="enscript-keyword">if</span> (encp-&gt;refcount &lt;= 0 &amp;&amp; encp-&gt;kmod_id != 0) {
				SLIST_REMOVE(&amp;hfs_encoding_list, encp, hfs_encoding, link);
				lck_mtx_unlock(&amp;encodinglst_mutex);
    				FREE(encp, M_TEMP);
    				<span class="enscript-keyword">return</span> (0);
 			} <span class="enscript-keyword">else</span> {
 				lck_mtx_unlock(&amp;encodinglst_mutex);
				<span class="enscript-keyword">return</span> (1);   <span class="enscript-comment">/* busy */</span>
			}
			<span class="enscript-keyword">break</span>;
		}
	}
	lck_mtx_unlock(&amp;encodinglst_mutex);

	<span class="enscript-keyword">return</span> (0);
}


<span class="enscript-comment">/*
 * hfs_getconverter - get HFS encoding converters
 *
 * Normally called during the mounting of an hfs voulume.
 */</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">hfs_getconverter</span>(u_int32_t encoding, hfs_to_unicode_func_t *get_unicode, unicode_to_hfs_func_t *get_hfsname)
{
	<span class="enscript-type">struct</span> hfs_encoding *encp;
	<span class="enscript-type">int</span> found = 0;

	lck_mtx_lock(&amp;encodinglst_mutex);
	SLIST_FOREACH(encp, &amp;hfs_encoding_list, link) {
		<span class="enscript-keyword">if</span> (encp-&gt;encoding == encoding) {
			found = 1;
			*get_unicode = encp-&gt;get_unicode_func;
			*get_hfsname = encp-&gt;get_hfsname_func;
			++encp-&gt;refcount;
			<span class="enscript-keyword">break</span>;
		}
	}
	lck_mtx_unlock(&amp;encodinglst_mutex);

	<span class="enscript-keyword">if</span> (!found) {
		*get_unicode = NULL;
		*get_hfsname = NULL;
		<span class="enscript-keyword">return</span> (EINVAL);
	}
	
	<span class="enscript-keyword">return</span> (0);
}


<span class="enscript-comment">/*
 * hfs_relconverter - release interest in an HFS encoding converter
 *
 * Normally called during the unmounting of an hfs voulume.
 */</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">hfs_relconverter</span>(u_int32_t encoding)
{
	<span class="enscript-type">struct</span> hfs_encoding *encp;

	lck_mtx_lock(&amp;encodinglst_mutex);
	SLIST_FOREACH(encp, &amp;hfs_encoding_list, link) {
		<span class="enscript-keyword">if</span> (encp-&gt;encoding == encoding) {
			encp-&gt;refcount--;
			
			<span class="enscript-comment">/* if converter is no longer in use, release it */</span>
			<span class="enscript-keyword">if</span> (encp-&gt;refcount &lt;= 0 &amp;&amp; encp-&gt;kmod_id != 0) {
				uint32_t loadTag = (uint32_t)encp-&gt;kmod_id;

				SLIST_REMOVE(&amp;hfs_encoding_list, encp, hfs_encoding, link);
				lck_mtx_unlock(&amp;encodinglst_mutex);
 
 				FREE(encp, M_TEMP);
   				(<span class="enscript-type">void</span>)OSKextUnloadKextWithLoadTag(loadTag);
				<span class="enscript-keyword">return</span> (0);
			}
			lck_mtx_unlock(&amp;encodinglst_mutex);
			<span class="enscript-keyword">return</span> (0);
		}
	}
	lck_mtx_unlock(&amp;encodinglst_mutex);

	<span class="enscript-keyword">return</span> (EINVAL);
}

<span class="enscript-comment">/*
 * Convert HFS encoded string into UTF-8
 *
 * Unicode output is fully decomposed
 * '/' chars are converted to ':'
 */</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">hfs_to_utf8</span>(ExtendedVCB *vcb, <span class="enscript-type">const</span> Str31 hfs_str, ByteCount maxDstLen, ByteCount *actualDstLen, <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span>* dstStr)
{
	<span class="enscript-type">int</span> error;
	UniChar uniStr[MAX_HFS_UNICODE_CHARS];
	ItemCount uniCount;
	size_t utf8len;
	hfs_to_unicode_func_t hfs_get_unicode = VCBTOHFS(vcb)-&gt;hfs_get_unicode;
	u_int8_t pascal_length = 0;

	<span class="enscript-comment">/* 
	 * Validate the length of the Pascal-style string before passing it
	 * down to the decoding engine.
	 */</span>
	pascal_length = *((<span class="enscript-type">const</span> u_int8_t*)(hfs_str));
	<span class="enscript-keyword">if</span> (pascal_length &gt; 31) {
		<span class="enscript-comment">/* invalid string; longer than 31 bytes */</span>
		error = EINVAL;
		<span class="enscript-keyword">return</span> error;
	}	
	
	error = hfs_get_unicode(hfs_str, uniStr, MAX_HFS_UNICODE_CHARS, &amp;uniCount);
	
	<span class="enscript-keyword">if</span> (uniCount == 0)
		error = EINVAL;

	<span class="enscript-keyword">if</span> (error == 0) {
		error = utf8_encodestr(uniStr, uniCount * <span class="enscript-keyword">sizeof</span>(UniChar), dstStr, &amp;utf8len, maxDstLen , <span class="enscript-string">':'</span>, 0);
		<span class="enscript-keyword">if</span> (error == ENAMETOOLONG)
			*actualDstLen = utf8_encodelen(uniStr, uniCount * <span class="enscript-keyword">sizeof</span>(UniChar), <span class="enscript-string">':'</span>, 0);
		<span class="enscript-keyword">else</span>
			*actualDstLen = utf8len;
	}

	<span class="enscript-keyword">return</span> error;
}

<span class="enscript-comment">/*
 * When an HFS name cannot be encoded with the current
 * volume encoding then MacRoman is used as a fallback.
 */</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">mac_roman_to_utf8</span>(<span class="enscript-type">const</span> Str31 hfs_str, ByteCount maxDstLen, ByteCount *actualDstLen, <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span>* dstStr)
{
	<span class="enscript-type">int</span> error;
	UniChar uniStr[MAX_HFS_UNICODE_CHARS];
	ItemCount uniCount;
	size_t utf8len;
	u_int8_t pascal_length = 0;

	<span class="enscript-comment">/* 
	 * Validate the length of the Pascal-style string before passing it
	 * down to the decoding engine.
	 */</span>
	pascal_length = *((<span class="enscript-type">const</span> u_int8_t*)(hfs_str));
	<span class="enscript-keyword">if</span> (pascal_length &gt; 31) {
		<span class="enscript-comment">/* invalid string; longer than 31 bytes */</span>
		error = EINVAL;
		<span class="enscript-keyword">return</span> error;
	}

	error = mac_roman_to_unicode(hfs_str, uniStr, MAX_HFS_UNICODE_CHARS, &amp;uniCount);
	
	<span class="enscript-keyword">if</span> (uniCount == 0)
		error = EINVAL;

	<span class="enscript-keyword">if</span> (error == 0) {
		error = utf8_encodestr(uniStr, uniCount * <span class="enscript-keyword">sizeof</span>(UniChar), dstStr, &amp;utf8len, maxDstLen , <span class="enscript-string">':'</span>, 0);
		<span class="enscript-keyword">if</span> (error == ENAMETOOLONG)
			*actualDstLen = utf8_encodelen(uniStr, uniCount * <span class="enscript-keyword">sizeof</span>(UniChar), <span class="enscript-string">':'</span>, 0);
		<span class="enscript-keyword">else</span>
			*actualDstLen = utf8len;
	}

	<span class="enscript-keyword">return</span> error;
}

<span class="enscript-comment">/*
 * Convert Unicode string into HFS encoding
 *
 * ':' chars are converted to '/'
 * Assumes input represents fully decomposed Unicode
 */</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">unicode_to_hfs</span>(ExtendedVCB *vcb, ByteCount srcLen, u_int16_t* srcStr, Str31 dstStr, <span class="enscript-type">int</span> retry)
{
	<span class="enscript-type">int</span> error;
	unicode_to_hfs_func_t hfs_get_hfsname = VCBTOHFS(vcb)-&gt;hfs_get_hfsname;

	error = hfs_get_hfsname(srcStr, srcLen/<span class="enscript-keyword">sizeof</span>(UniChar), dstStr);
	<span class="enscript-keyword">if</span> (error &amp;&amp; retry) {
		error = unicode_to_mac_roman(srcStr, srcLen/<span class="enscript-keyword">sizeof</span>(UniChar), dstStr);
	}
	<span class="enscript-keyword">return</span> error;
}

<span class="enscript-comment">/*
 * Convert UTF-8 string into HFS encoding
 *
 * ':' chars are converted to '/'
 * Assumes input represents fully decomposed Unicode
 */</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">utf8_to_hfs</span>(ExtendedVCB *vcb, ByteCount srcLen, <span class="enscript-type">const</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span>* srcStr, Str31 dstStr<span class="enscript-comment">/*, int retry*/</span>)
{
	<span class="enscript-type">int</span> error;
	UniChar uniStr[MAX_HFS_UNICODE_CHARS];
	size_t ucslen;

	error = utf8_decodestr(srcStr, srcLen, uniStr, &amp;ucslen, <span class="enscript-keyword">sizeof</span>(uniStr), <span class="enscript-string">':'</span>, 0);
	<span class="enscript-keyword">if</span> (error == 0)
		error = unicode_to_hfs(vcb, ucslen, uniStr, dstStr, 1);

	<span class="enscript-keyword">return</span> error;
}


<span class="enscript-type">int</span>
<span class="enscript-function-name">utf8_to_mac_roman</span>(ByteCount srcLen, <span class="enscript-type">const</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span>* srcStr, Str31 dstStr)
{
	<span class="enscript-type">int</span> error;
	UniChar uniStr[MAX_HFS_UNICODE_CHARS];
	size_t ucslen;

	error = utf8_decodestr(srcStr, srcLen, uniStr, &amp;ucslen, <span class="enscript-keyword">sizeof</span>(uniStr), <span class="enscript-string">':'</span>, 0);
	<span class="enscript-keyword">if</span> (error == 0)
		error = unicode_to_mac_roman(uniStr, ucslen/<span class="enscript-keyword">sizeof</span>(UniChar), dstStr);

	<span class="enscript-keyword">return</span> error;
}

<span class="enscript-comment">/*
 * HFS MacRoman to/from Unicode conversions are built into the kernel
 * All others hfs encodings are loadable.
 */</span>

<span class="enscript-comment">/* 0x00A0 - 0x00FF = Latin 1 Supplement (30 total) */</span>
<span class="enscript-type">static</span> u_int8_t gLatin1Table[] = {
  <span class="enscript-comment">/*		  0     1     2     3     4     5     6     7     8     9     A     B     C     D     E     F  */</span>
  <span class="enscript-comment">/* 0x00A0 */</span>	0xCA, 0xC1, 0xA2, 0xA3, 0xDB, 0xB4,  <span class="enscript-string">'?'</span>, 0xA4, 0xAC, 0xA9, 0xBB, 0xC7, 0xC2,  <span class="enscript-string">'?'</span>, 0xA8, 0xF8,
  <span class="enscript-comment">/* 0x00B0 */</span>	0xA1, 0XB1,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>, 0xAB, 0xB5, 0xA6, 0xe1, 0xFC,  <span class="enscript-string">'?'</span>, 0xBC, 0xC8,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>, 0xC0,
  <span class="enscript-comment">/* 0x00C0 */</span>	 <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>, 0xAE,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,
  <span class="enscript-comment">/* 0x00D0 */</span>	 <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>, 0xAF,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>, 0xA7,
  <span class="enscript-comment">/* 0x00E0 */</span>	 <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>, 0xBE,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,
  <span class="enscript-comment">/* 0x00F0 */</span>	 <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>, 0xD6, 0xBF,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>
};

<span class="enscript-comment">/* 0x02C0 - 0x02DF = Spacing Modifiers (8 total) */</span>
<span class="enscript-type">static</span> u_int8_t gSpaceModsTable[] = {
  <span class="enscript-comment">/*		  0     1     2     3     4     5     6     7     8     9     A     B     C     D     E     F  */</span>
  <span class="enscript-comment">/* 0x02C0 */</span>	 <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>, 0xF6, 0xFF,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,
  <span class="enscript-comment">/* 0x02D0 */</span>	 <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>, 0xF9, 0xFA, 0xFB, 0xFE, 0xF7, 0xFD,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>
};

<span class="enscript-comment">/* 0x2010 - 0x20AF = General Punctuation (17 total) */</span>
<span class="enscript-type">static</span> u_int8_t gPunctTable[] = {
  <span class="enscript-comment">/*		  0     1     2     3     4     5     6     7     8     9     A     B     C     D     E     F  */</span>
  <span class="enscript-comment">/* 0x2010 */</span>	 <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>, 0xd0, 0xd1,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>, 0xd4, 0xd5, 0xe2,  <span class="enscript-string">'?'</span>, 0xd2, 0xd3, 0xe3,  <span class="enscript-string">'?'</span>,
  <span class="enscript-comment">/* 0x2020 */</span>	0xa0, 0xe0, 0xa5,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>, 0xc9,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,
  <span class="enscript-comment">/* 0x2030 */</span>	0xe4,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>, 0xdc, 0xdd,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,
  <span class="enscript-comment">/* 0x2040 */</span>	 <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>, 0xda,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,
  <span class="enscript-comment">/* 0x2050 */</span>	 <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,
  <span class="enscript-comment">/* 0x2060 */</span>	 <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,
  <span class="enscript-comment">/* 0x2070 */</span>	 <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,
  <span class="enscript-comment">/* 0x2080 */</span>	 <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,
  <span class="enscript-comment">/* 0x2090 */</span>	 <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,
  <span class="enscript-comment">/* 0x20A0 */</span>	 <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>, 0xdb,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>
};

<span class="enscript-comment">/* 0x22xx = Mathematical Operators (11 total) */</span>
<span class="enscript-type">static</span> u_int8_t gMathTable[] = {
  <span class="enscript-comment">/*		  0     1     2     3     4     5     6     7     8     9     A     B     C     D     E     F  */</span>
  <span class="enscript-comment">/* 0x2200 */</span>	 <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>, 0xb6,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>, 0xc6,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>, 0xb8,
  <span class="enscript-comment">/* 0x2210 */</span>	 <span class="enscript-string">'?'</span>, 0xb7,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>, 0xc3,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>, 0xb0,  <span class="enscript-string">'?'</span>,
  <span class="enscript-comment">/* 0x2220 */</span>	 <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>, 0xba,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,
  <span class="enscript-comment">/* 0x2230 */</span>	 <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,
  <span class="enscript-comment">/* 0x2240 */</span>	 <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>, 0xc5,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,
  <span class="enscript-comment">/* 0x2250 */</span>	 <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,
  <span class="enscript-comment">/* 0x2260 */</span>	0xad,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>, 0xb2, 0xb3,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>
};

<span class="enscript-comment">/* */</span>
<span class="enscript-type">static</span> u_int8_t gReverseCombTable[] = {
  <span class="enscript-comment">/*		  0     1     2     3     4     5     6     7     8     9     A     B     C     D     E     F  */</span>
  <span class="enscript-comment">/* 0x40 */</span>	0xDA, 0x40, 0xDA, 0xDA, 0xDA, 0x56, 0xDA, 0xDA, 0xDA, 0x6C, 0xDA, 0xDA, 0xDA, 0xDA, 0x82, 0x98,
  <span class="enscript-comment">/* 0x50 */</span>	0xDA, 0xDA, 0xDA, 0xDA, 0xDA, 0xAE, 0xDA, 0xDA, 0xDA, 0xC4, 0xDA, 0xDA, 0xDA, 0xDA, 0xDA, 0xDA,
  <span class="enscript-comment">/* 0x60 */</span>	0xDA, 0x4B, 0xDA, 0xDA, 0xDA, 0x61, 0xDA, 0xDA, 0xDA, 0x77, 0xDA, 0xDA, 0xDA, 0xDA, 0x8D, 0xA3,
  <span class="enscript-comment">/* 0x70 */</span>	0xDA, 0xDA, 0xDA, 0xDA, 0xDA, 0xB9, 0xDA, 0xDA, 0xDA, 0xCF, 0xDA, 0xDA, 0xDA, 0xDA, 0xDA, 0xDA,

  <span class="enscript-comment">/* Combining Diacritical Marks (0x0300 - 0x030A) */</span>
  <span class="enscript-comment">/*              0     1     2     3     4     5     6     7     8     9     A  */</span>
  <span class="enscript-comment">/*  'A'   */</span>
  <span class="enscript-comment">/* 0x0300 */</span>	0xCB, 0xE7, 0xE5, 0xCC,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>, 0x80,  <span class="enscript-string">'?'</span>, 0x81,

  <span class="enscript-comment">/*  'a'   */</span>
  <span class="enscript-comment">/* 0x0300 */</span>	0x88, 0x87, 0x89, 0x8B,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>, 0x8A,  <span class="enscript-string">'?'</span>, 0x8C,

  <span class="enscript-comment">/*  'E'   */</span>
  <span class="enscript-comment">/* 0x0300 */</span>	0xE9, 0x83, 0xE6,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>, 0xE8,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,

  <span class="enscript-comment">/*  'e'   */</span>
  <span class="enscript-comment">/* 0x0300 */</span>	0x8F, 0x8E, 0x90,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>, 0x91,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,

  <span class="enscript-comment">/*  'I'   */</span>
  <span class="enscript-comment">/* 0x0300 */</span>	0xED, 0xEA, 0xEB,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>, 0xEC,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,

  <span class="enscript-comment">/*  'i'   */</span>
  <span class="enscript-comment">/* 0x0300 */</span>	0x93, 0x92, 0x94,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>, 0x95,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,

  <span class="enscript-comment">/*  'N'   */</span>
  <span class="enscript-comment">/* 0x0300 */</span>	 <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>, 0x84,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,

  <span class="enscript-comment">/*  'n'   */</span>
  <span class="enscript-comment">/* 0x0300 */</span>	 <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>, 0x96,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,

  <span class="enscript-comment">/*  'O'   */</span>
  <span class="enscript-comment">/* 0x0300 */</span>	0xF1, 0xEE, 0xEF, 0xCD,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>, 0x85,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,

  <span class="enscript-comment">/*  'o'   */</span>
  <span class="enscript-comment">/* 0x0300 */</span>	0x98, 0x97, 0x99, 0x9B,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>, 0x9A,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,

  <span class="enscript-comment">/*  'U'   */</span>
  <span class="enscript-comment">/* 0x0300 */</span>	0xF4, 0xF2, 0xF3,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>, 0x86,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,

  <span class="enscript-comment">/*  'u'   */</span>
  <span class="enscript-comment">/* 0x0300 */</span>	0x9D, 0x9C, 0x9E,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>, 0x9F,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,

  <span class="enscript-comment">/*  'Y'   */</span>
  <span class="enscript-comment">/* 0x0300 */</span>	 <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>, 0xD9,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,

  <span class="enscript-comment">/*  'y'   */</span>
  <span class="enscript-comment">/* 0x0300 */</span>	 <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>, 0xD8,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,

  <span class="enscript-comment">/*  else  */</span>
  <span class="enscript-comment">/* 0x0300 */</span>	 <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>,  <span class="enscript-string">'?'</span>
};


<span class="enscript-comment">/*
 * Convert Unicode string into HFS MacRoman encoding
 *
 * Assumes Unicode input is fully decomposed
 */</span>
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">unicode_to_mac_roman</span>(UniChar *uni_str, u_int32_t unicodeChars, Str31 hfs_str)
{
	u_int8_t	*p;
	<span class="enscript-type">const</span> UniChar	*u;
	UniChar		c;
	UniChar		mask;
	u_int16_t	inputChars;
	u_int16_t	pascalChars;
	OSErr		result = noErr;
	u_int8_t	lsb;
	u_int8_t	prevChar;
	u_int8_t	mc;

	mask = (UniChar) 0xFF80;
	p = &amp;hfs_str[1];
	u = uni_str;
	inputChars = unicodeChars;
	pascalChars = prevChar = 0;
	
	<span class="enscript-keyword">while</span> (inputChars) {
		c = *(u++);
		lsb = (u_int8_t) c;

		<span class="enscript-comment">/*
		 * If its not 7-bit ascii, then we need to map it
		 */</span>
		<span class="enscript-keyword">if</span> ( c &amp; mask ) {
			mc = <span class="enscript-string">'?'</span>;
			<span class="enscript-keyword">switch</span> (c &amp; 0xFF00) {
			<span class="enscript-keyword">case</span> <span class="enscript-reference">0x0000</span>:
				<span class="enscript-keyword">if</span> (lsb &gt;= 0xA0)
					mc = gLatin1Table[lsb - 0xA0];
				<span class="enscript-keyword">break</span>;

			<span class="enscript-keyword">case</span> <span class="enscript-reference">0x0200</span>:
				<span class="enscript-keyword">if</span> (lsb &gt;= 0xC0 &amp;&amp; lsb &lt;= 0xDF)
					mc = gSpaceModsTable[lsb - 0xC0];
				<span class="enscript-keyword">break</span>;

			<span class="enscript-keyword">case</span> <span class="enscript-reference">0x2000</span>:
				<span class="enscript-keyword">if</span> (lsb &gt;= 0x10 &amp;&amp; lsb &lt;= 0xAF)
					mc = gPunctTable[lsb- 0x10];
				<span class="enscript-keyword">break</span>;

			<span class="enscript-keyword">case</span> <span class="enscript-reference">0x2200</span>:
				<span class="enscript-keyword">if</span> (lsb &lt; 0x68)
					mc = gMathTable[lsb];
				<span class="enscript-keyword">break</span>;

			<span class="enscript-keyword">case</span> <span class="enscript-reference">0x0300</span>:
				<span class="enscript-keyword">if</span> (c &lt;= 0x030A) {
					<span class="enscript-keyword">if</span> (prevChar &gt;= <span class="enscript-string">'A'</span> &amp;&amp; prevChar &lt; <span class="enscript-string">'z'</span>) {
						mc = gReverseCombTable[gReverseCombTable[prevChar - 0x40] + lsb];
						--p;	<span class="enscript-comment">/* backup over base char */</span>
						--pascalChars;
					}
				} <span class="enscript-keyword">else</span> {
					<span class="enscript-keyword">switch</span> (c) {
					<span class="enscript-keyword">case</span> <span class="enscript-reference">0x0327</span>:	<span class="enscript-comment">/* combining cedilla */</span>
						<span class="enscript-keyword">if</span> (prevChar == <span class="enscript-string">'C'</span>)
							mc = 0x82;
						<span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (prevChar == <span class="enscript-string">'c'</span>)
							mc = 0x8D;
						<span class="enscript-keyword">else</span>
							<span class="enscript-keyword">break</span>;
						--p;	<span class="enscript-comment">/* backup over base char */</span>
						--pascalChars;
						<span class="enscript-keyword">break</span>;

					<span class="enscript-keyword">case</span> <span class="enscript-reference">0x03A9</span>: mc = 0xBD; <span class="enscript-keyword">break</span>;	<span class="enscript-comment">/* omega */</span>

					<span class="enscript-keyword">case</span> <span class="enscript-reference">0x03C0</span>: mc = 0xB9; <span class="enscript-keyword">break</span>;	<span class="enscript-comment">/* pi */</span>
					}
				}
				<span class="enscript-keyword">break</span>;
				
			<span class="enscript-reference">default</span>:
				<span class="enscript-keyword">switch</span> (c) {
				<span class="enscript-keyword">case</span> <span class="enscript-reference">0x0131</span>: mc = 0xf5; <span class="enscript-keyword">break</span>;	<span class="enscript-comment">/* dotless i */</span>

				<span class="enscript-keyword">case</span> <span class="enscript-reference">0x0152</span>: mc = 0xce; <span class="enscript-keyword">break</span>;	<span class="enscript-comment">/* OE */</span>

				<span class="enscript-keyword">case</span> <span class="enscript-reference">0x0153</span>: mc = 0xcf; <span class="enscript-keyword">break</span>;	<span class="enscript-comment">/* oe */</span>

				<span class="enscript-keyword">case</span> <span class="enscript-reference">0x0192</span>: mc = 0xc4; <span class="enscript-keyword">break</span>;	<span class="enscript-comment">/* Ä */</span>

				<span class="enscript-keyword">case</span> <span class="enscript-reference">0x2122</span>: mc = 0xaa; <span class="enscript-keyword">break</span>;	<span class="enscript-comment">/* TM */</span>

				<span class="enscript-keyword">case</span> <span class="enscript-reference">0x25ca</span>: mc = 0xd7; <span class="enscript-keyword">break</span>;	<span class="enscript-comment">/* diamond */</span>

				<span class="enscript-keyword">case</span> <span class="enscript-reference">0xf8ff</span>: mc = 0xf0; <span class="enscript-keyword">break</span>;	<span class="enscript-comment">/* apple logo */</span>

				<span class="enscript-keyword">case</span> <span class="enscript-reference">0xfb01</span>: mc = 0xde; <span class="enscript-keyword">break</span>;	<span class="enscript-comment">/* fi */</span>

				<span class="enscript-keyword">case</span> <span class="enscript-reference">0xfb02</span>: mc = 0xdf; <span class="enscript-keyword">break</span>;	<span class="enscript-comment">/* fl */</span>
				}
			} <span class="enscript-comment">/* end switch (c &amp; 0xFF00) */</span>
			
			<span class="enscript-comment">/*
			 * If we have an unmapped character then we need to mangle the name...
			 */</span>
			<span class="enscript-keyword">if</span> (mc == <span class="enscript-string">'?'</span>)
				result = kTECUsedFallbacksStatus;
			
			prevChar = 0;
			lsb = mc;

		} <span class="enscript-keyword">else</span> {
			prevChar = lsb;
		}

		<span class="enscript-keyword">if</span> (pascalChars &gt;= 31)
			<span class="enscript-keyword">break</span>;

		*(p++) = lsb;
		++pascalChars;
		--inputChars;

	} <span class="enscript-comment">/* end while */</span>
	
	hfs_str[0] = pascalChars;
	
	<span class="enscript-keyword">if</span> (inputChars &gt; 0)
		result = ENAMETOOLONG;	<span class="enscript-comment">/* ran out of room! */</span>

	<span class="enscript-keyword">return</span> result;
}


<span class="enscript-type">static</span> UniChar gHiBitBaseUnicode[128] = {
  <span class="enscript-comment">/* 0x80 */</span>	0x0041, 0x0041, 0x0043, 0x0045, 0x004e, 0x004f, 0x0055, 0x0061, 
  <span class="enscript-comment">/* 0x88 */</span>	0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x0063, 0x0065, 0x0065, 
  <span class="enscript-comment">/* 0x90 */</span>	0x0065, 0x0065, 0x0069, 0x0069, 0x0069, 0x0069, 0x006e, 0x006f, 
  <span class="enscript-comment">/* 0x98 */</span>	0x006f, 0x006f, 0x006f, 0x006f, 0x0075, 0x0075, 0x0075, 0x0075, 
  <span class="enscript-comment">/* 0xa0 */</span>	0x2020, 0x00b0, 0x00a2, 0x00a3, 0x00a7, 0x2022, 0x00b6, 0x00df, 
  <span class="enscript-comment">/* 0xa8 */</span>	0x00ae, 0x00a9, 0x2122, 0x00b4, 0x00a8, 0x2260, 0x00c6, 0x00d8, 
  <span class="enscript-comment">/* 0xb0 */</span>	0x221e, 0x00b1, 0x2264, 0x2265, 0x00a5, 0x00b5, 0x2202, 0x2211, 
  <span class="enscript-comment">/* 0xb8 */</span>	0x220f, 0x03c0, 0x222b, 0x00aa, 0x00ba, 0x03a9, 0x00e6, 0x00f8, 
  <span class="enscript-comment">/* 0xc0 */</span>	0x00bf, 0x00a1, 0x00ac, 0x221a, 0x0192, 0x2248, 0x2206, 0x00ab, 
  <span class="enscript-comment">/* 0xc8 */</span>	0x00bb, 0x2026, 0x00a0, 0x0041, 0x0041, 0x004f, 0x0152, 0x0153, 
  <span class="enscript-comment">/* 0xd0 */</span>	0x2013, 0x2014, 0x201c, 0x201d, 0x2018, 0x2019, 0x00f7, 0x25ca, 
  <span class="enscript-comment">/* 0xd8 */</span>	0x0079, 0x0059, 0x2044, 0x20ac, 0x2039, 0x203a, 0xfb01, 0xfb02, 
  <span class="enscript-comment">/* 0xe0 */</span>	0x2021, 0x00b7, 0x201a, 0x201e, 0x2030, 0x0041, 0x0045, 0x0041, 
  <span class="enscript-comment">/* 0xe8 */</span>	0x0045, 0x0045, 0x0049, 0x0049, 0x0049, 0x0049, 0x004f, 0x004f, 
  <span class="enscript-comment">/* 0xf0 */</span>	0xf8ff, 0x004f, 0x0055, 0x0055, 0x0055, 0x0131, 0x02c6, 0x02dc, 
  <span class="enscript-comment">/* 0xf8 */</span>	0x00af, 0x02d8, 0x02d9, 0x02da, 0x00b8, 0x02dd, 0x02db, 0x02c7
};

<span class="enscript-type">static</span> UniChar gHiBitCombUnicode[128] = {
  <span class="enscript-comment">/* 0x80 */</span>	0x0308, 0x030a, 0x0327, 0x0301, 0x0303, 0x0308, 0x0308, 0x0301, 
  <span class="enscript-comment">/* 0x88 */</span>	0x0300, 0x0302, 0x0308, 0x0303, 0x030a, 0x0327, 0x0301, 0x0300, 
  <span class="enscript-comment">/* 0x90 */</span>	0x0302, 0x0308, 0x0301, 0x0300, 0x0302, 0x0308, 0x0303, 0x0301, 
  <span class="enscript-comment">/* 0x98 */</span>	0x0300, 0x0302, 0x0308, 0x0303, 0x0301, 0x0300, 0x0302, 0x0308, 
  <span class="enscript-comment">/* 0xa0 */</span>	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  <span class="enscript-comment">/* 0xa8 */</span>	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 
  <span class="enscript-comment">/* 0xb0 */</span>	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 
  <span class="enscript-comment">/* 0xb8 */</span>	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 
  <span class="enscript-comment">/* 0xc0 */</span>	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 
  <span class="enscript-comment">/* 0xc8 */</span>	0x0000, 0x0000, 0x0000, 0x0300, 0x0303, 0x0303, 0x0000, 0x0000, 
  <span class="enscript-comment">/* 0xd0 */</span>	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 
  <span class="enscript-comment">/* 0xd8 */</span>	0x0308, 0x0308, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 
  <span class="enscript-comment">/* 0xe0 */</span>	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0302, 0x0302, 0x0301, 
  <span class="enscript-comment">/* 0xe8 */</span>	0x0308, 0x0300, 0x0301, 0x0302, 0x0308, 0x0300, 0x0301, 0x0302, 
  <span class="enscript-comment">/* 0xf0 */</span>	0x0000, 0x0300, 0x0301, 0x0302, 0x0300, 0x0000, 0x0000, 0x0000, 
  <span class="enscript-comment">/* 0xf8 */</span>	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000
};


<span class="enscript-comment">/*
 * Convert HFS MacRoman encoded string into Unicode
 *
 * Unicode output is fully decomposed
 */</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">mac_roman_to_unicode</span>(<span class="enscript-type">const</span> Str31 hfs_str, UniChar *uni_str,
				__unused u_int32_t maxCharLen, u_int32_t *unicodeChars)
{
	<span class="enscript-type">const</span> u_int8_t  *p;
	UniChar  *u;
	u_int16_t  pascalChars;
	u_int8_t  c;

	p = hfs_str;
	u = uni_str;

	*unicodeChars = pascalChars = *(p++);	<span class="enscript-comment">/* pick up length byte */</span>

	<span class="enscript-keyword">while</span> (pascalChars--) {
		c = *(p++);

		<span class="enscript-keyword">if</span> ( (int8_t) c &gt;= 0 ) {		<span class="enscript-comment">/* check if seven bit ascii */</span>
			*(u++) = (UniChar) c;	<span class="enscript-comment">/* just pad high byte with zero */</span>
		} <span class="enscript-keyword">else</span> { <span class="enscript-comment">/* its a hi bit character */</span>
			UniChar uc;

			c &amp;= 0x7F;
			*(u++) = uc = gHiBitBaseUnicode[c];
			
			<span class="enscript-comment">/*
			 * if the unicode character we get back is an alpha char
			 * then we must have an additional combining character
			 */</span>
			<span class="enscript-keyword">if</span> ((uc &lt;= (UniChar) <span class="enscript-string">'z'</span>) &amp;&amp; (uc &gt;= (UniChar) <span class="enscript-string">'A'</span>)) {
				*(u++) = gHiBitCombUnicode[c];
				++(*unicodeChars);
			}
		}
	}
	
	<span class="enscript-keyword">return</span> noErr;
}

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CONFIG_STD_HFS */</span>

#<span class="enscript-reference">else</span> <span class="enscript-comment">/* not HFS */</span>

<span class="enscript-comment">/*
 * These function prototypes are here because hfs.h is not #included
 * so its prototypes are not provided. These are needed because they are exported
 * as KPI for the conversion subroutines during mounting of HFS standard.
 */</span>
<span class="enscript-type">int</span> <span class="enscript-function-name">hfs_addconverter</span>(<span class="enscript-type">int</span> id, u_int32_t encoding, <span class="enscript-type">void</span> * get_unicode, <span class="enscript-type">void</span> * get_hfsname);
<span class="enscript-type">int</span> <span class="enscript-function-name">hfs_getconverter</span>(u_int32_t encoding, <span class="enscript-type">void</span> *get_unicode, <span class="enscript-type">void</span> *get_hfsname);
<span class="enscript-type">int</span> <span class="enscript-function-name">hfs_relconverter</span>(u_int32_t encoding);
<span class="enscript-type">int</span> <span class="enscript-function-name">hfs_remconverter</span>(<span class="enscript-type">int</span> id, u_int32_t encoding);

<span class="enscript-comment">/* Function stubs are needed for KPI export */</span>

<span class="enscript-type">int</span> <span class="enscript-function-name">hfs_addconverter</span>( __unused <span class="enscript-type">int</span> id, 
					  __unused u_int32_t encoding, 
					  __unused <span class="enscript-type">void</span> * get_unicode, 
					  __unused <span class="enscript-type">void</span> * get_hfsname )
{
	<span class="enscript-keyword">return</span>(0);
}

<span class="enscript-type">int</span> <span class="enscript-function-name">hfs_getconverter</span>(__unused u_int32_t encoding, __unused <span class="enscript-type">void</span> *get_unicode, __unused <span class="enscript-type">void</span> *get_hfsname)
{
	<span class="enscript-keyword">return</span>(EINVAL);
}

<span class="enscript-type">int</span> <span class="enscript-function-name">hfs_relconverter</span>(__unused u_int32_t encoding)
{
	<span class="enscript-keyword">return</span>(EINVAL);
}

<span class="enscript-type">int</span> <span class="enscript-function-name">hfs_remconverter</span>(__unused <span class="enscript-type">int</span> id, __unused u_int32_t encoding)
{
	<span class="enscript-keyword">return</span>(0);
}
#<span class="enscript-reference">endif</span>


</pre>
<hr />
</body></html>